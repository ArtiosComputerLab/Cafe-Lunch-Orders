// Add this authentication check to the VERY TOP of your existing index.html <script> section
// This replaces your current DOMContentLoaded function

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, checking authentication...');
  
  // FIRST: Check authentication before doing anything else
  if (!checkAuthentication()) {
    return; // Will redirect to login, so stop execution
  }
  
  // SECOND: Show authenticated user info
  showAuthenticatedUser();
  
  // THIRD: Continue with your existing initialization
  checkStoreHours();
  generateDayTabs();
  generateMenus();
  setupEventListeners();
  loadUserDataFromCookies();
  setupAutoSave();
  updateCart();
  validateForm();
  
  console.log('Initialization complete for authenticated user');
});

/**
 * Check if user is authenticated to access ordering system
 */
function checkAuthentication() {
  const authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
  const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
  
  console.log('Checking ordering authentication...');
  console.log('Email:', authenticatedEmail);
  console.log('Expiry:', authExpiry ? new Date(authExpiry) : 'None');
  
  // Check if authentication exists and is not expired
  if (!authenticatedEmail || !authExpiry || Date.now() >= authExpiry) {
    console.log('‚ùå No valid authentication - redirecting to login');
    redirectToLogin();
    return false;
  }
  
  console.log('‚úÖ Authentication valid for ordering');
  return true;
}

/**
 * Redirect to login page with message
 */
function redirectToLogin() {
  // Clear any existing auth
  sessionStorage.removeItem('authenticatedEmail');
  sessionStorage.removeItem('authExpiry');
  
  // Show authentication required message
  document.body.innerHTML = `
    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: Arial, sans-serif;">
      <div style="text-align: center; background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px;">
        <div style="font-size: 4em; margin-bottom: 20px;">üîí</div>
        <h2 style="color: #4285f4; margin-bottom: 15px; font-size: 2em;">Login Required</h2>
        <p style="color: #666; margin-bottom: 25px; font-size: 1.1em;">Please login to access the cafe ordering system</p>
        <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
          <h4 style="color: #1976d2; margin-bottom: 10px;">üîê Secure Family Portal</h4>
          <ul style="margin: 0; padding-left: 20px; color: #333; font-size: 0.9em;">
            <li>Your order history is private and protected</li>
            <li>Quick access to all your family's orders</li>
            <li>Easy cancellation and refund requests</li>
          </ul>
        </div>
        <a href="login.html" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; text-decoration: none; padding: 15px 30px; border-radius: 10px; font-weight: 600; font-size: 16px; display: inline-block; transition: all 0.3s ease;">
          üçΩÔ∏è Go to Family Login
        </a>
        <div style="font-size: 14px; color: #999; margin-top: 15px;">Redirecting automatically in <span id="countdown">5</span> seconds...</div>
      </div>
    </div>
  `;
  
  // Countdown redirect
  let seconds = 5;
  const countdownElement = document.getElementById('countdown');
  const countdownInterval = setInterval(() => {
    seconds--;
    if (countdownElement) {
      countdownElement.textContent = seconds;
    }
    if (seconds <= 0) {
      clearInterval(countdownInterval);
      window.location.href = 'login.html';
    }
  }, 1000);
}

/**
 * Show authenticated user info at top of ordering page
 */
function showAuthenticatedUser() {
  const authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
  const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
  
  // Update the existing header with user info
  const header = document.querySelector('.header');
  if (header) {
    // Add user info bar above the existing header content
    const userInfoBar = document.createElement('div');
    userInfoBar.style.cssText = `
      background: rgba(255,255,255,0.1);
      padding: 10px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      font-size: 0.9em;
    `;
    
    const timeLeft = Math.floor((authExpiry - Date.now()) / (1000 * 60 * 60));
    
    userInfoBar.innerHTML = `
      <div style="display: flex; align-items: center; gap: 15px;">
        <span style="opacity: 0.9;">üîì Logged in as:</span>
        <span style="font-weight: 600;">${authenticatedEmail}</span>
      </div>
      <div style="display: flex; align-items: center; gap: 15px;">
        <span style="opacity: 0.8;">${timeLeft}h session</span>
        <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600;">
          Logout
        </button>
      </div>
    `;
    
    header.insertBefore(userInfoBar, header.firstChild);
  }
  
  // Pre-fill the email field with authenticated email
  const emailField = document.getElementById('family-email');
  if (emailField) {
    emailField.value = authenticatedEmail;
    emailField.readOnly = true; // Prevent changing email
    emailField.style.background = '#f0f9ff';
    emailField.style.cursor = 'not-allowed';
    
    // Add a note about the locked email
    const emailGroup = emailField.closest('.form-group');
    if (emailGroup) {
      const emailNote = document.createElement('small');
      emailNote.style.cssText = 'color: #666; font-style: italic; margin-top: 5px; display: block;';
      emailNote.textContent = 'Email is locked to your authenticated account for security';
      emailGroup.appendChild(emailNote);
    }
  }
}

/**
 * Enhanced logout function for ordering page
 */
function logout() {
  if (confirm('Are you sure you want to logout? Any unsaved order progress will be lost.')) {
    // Save current order progress if any items are selected
    const hasItems = orderItems && orderItems.length > 0;
    if (hasItems) {
      const saveProgress = confirm('You have items in your cart. Save them for when you login again?');
      if (saveProgress) {
        try {
          // Save order progress to localStorage with timestamp
          const orderProgress = {
            items: orderItems,
            children: getChildrenData(),
            timestamp: Date.now()
          };
          localStorage.setItem('artios_order_progress', JSON.stringify(orderProgress));
        } catch (error) {
          console.log('Could not save order progress:', error);
        }
      }
    }
    
    // Clear authentication
    sessionStorage.removeItem('authenticatedEmail');
    sessionStorage.removeItem('authExpiry');
    
    // Show logout message and redirect
    document.body.innerHTML = `
      <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f8f9fa; font-family: Arial, sans-serif;">
        <div style="text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          <div style="font-size: 3em; margin-bottom: 20px;">üëã</div>
          <h2 style="color: #4285f4; margin-bottom: 15px;">Logged Out Successfully</h2>
          <p style="color: #666; margin-bottom: 20px;">Thank you for using Artios Cafe!</p>
          <div style="font-size: 14px; color: #999;">Redirecting to login...</div>
        </div>
      </div>
    `;
    
    setTimeout(() => {
      window.location.href = 'dashboard.html'; // Go back to dashboard/login
    }, 2000);
  }
}

/**
 * Get current children data from form
 */
function getChildrenData() {
  const children = [];
  document.querySelectorAll('.child-section').forEach(function(child) {
    const childData = {
      firstName: child.querySelector('.child-first-name').value.trim(),
      lastName: child.querySelector('.child-last-name').value.trim(),
      grade: child.querySelector('.child-grade').value
    };
    if (childData.firstName) {
      children.push(childData);
    }
  });
  return children;
}

/**
 * Load saved order progress (if any)
 */
function loadOrderProgress() {
  try {
    const savedProgress = localStorage.getItem('artios_order_progress');
    if (savedProgress) {
      const progress = JSON.parse(savedProgress);
      
      // Check if progress is recent (within 24 hours)
      const progressAge = Date.now() - progress.timestamp;
      if (progressAge < 24 * 60 * 60 * 1000) {
        // Ask user if they want to restore progress
        const restoreProgress = confirm('We found an unfinished order from your last session. Would you like to restore it?');
        if (restoreProgress) {
          // Restore children data
          if (progress.children && progress.children.length > 0) {
            // Set first child
            if (progress.children[0]) {
              const firstChild = document.querySelector('.child-section');
              if (firstChild) {
                firstChild.querySelector('.child-first-name').value = progress.children[0].firstName || '';
                firstChild.querySelector('.child-last-name').value = progress.children[0].lastName || '';
                firstChild.querySelector('.child-grade').value = progress.children[0].grade || '';
              }
              
              // Add additional children
              for (let i = 1; i < progress.children.length; i++) {
                addChild();
                const newChild = document.querySelector('[data-child="' + (i + 1) + '"]');
                if (newChild) {
                  newChild.querySelector('.child-first-name').value = progress.children[i].firstName || '';
                  newChild.querySelector('.child-last-name').value = progress.children[i].lastName || '';
                  newChild.querySelector('.child-grade').value = progress.children[i].grade || '';
                }
              }
            }
            updateChildCheckboxes();
          }
          
          // Show notification about restored progress
          showNotification('Previous order progress restored! üîÑ', 'success');
        }
        
        // Clear the saved progress either way
        localStorage.removeItem('artios_order_progress');
      } else {
        // Progress is too old, clear it
        localStorage.removeItem('artios_order_progress');
      }
    }
  } catch (error) {
    console.log('Error loading order progress:', error);
    localStorage.removeItem('artios_order_progress');
  }
}

// Add this after your existing initialization in DOMContentLoaded
// Call this AFTER loadUserDataFromCookies()
setTimeout(() => {
  loadOrderProgress();
}, 1000);

// Make logout function globally accessible
window.logout = logout;

// ALSO UPDATE your submitOrder function to ensure it uses the authenticated email:
// Replace the familyEmail assignment in submitOrder with:
const familyEmail = sessionStorage.getItem('authenticatedEmail'); // Use authenticated email instead of form field

// ADD CSS for the user info bar
const authStyles = document.createElement('style');
authStyles.textContent = `
  .auth-user-bar {
    background: rgba(255,255,255,0.1);
    padding: 10px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    font-size: 0.9em;
  }
  
  .logout-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .logout-btn:hover {
    background: rgba(255,255,255,0.3);
  }
  
  @media (max-width: 768px) {
    .auth-user-bar {
      flex-direction: column;
      gap: 10px;
      text-align: center;
      padding: 15px;
    }
  }
`;
document.head.appendChild(authStyles);
