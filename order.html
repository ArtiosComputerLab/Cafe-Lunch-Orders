<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artios Academies of Sugar Hill - Cafe Lunch Order System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    /* AUTHENTICATION BAR STYLES - ADDED */
    .auth-user-bar {
      background: rgba(255,255,255,0.1);
      padding: 10px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      font-size: 0.9em;
      margin: -30px -30px 20px -30px;
    }
    
    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .header-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .artios-logo {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      object-fit: contain;
    }

    .header-text {
      text-align: left;
    }

    .header h1 {
      font-size: 2.2em;
      font-weight: 600;
      margin: 0;
      line-height: 1.2;
    }

    .header .subtitle {
      font-size: 1.1em;
      font-weight: 300;
      margin: 5px 0 0 0;
      opacity: 0.9;
    }

    .header .notice {
      background: rgba(255,255,255,0.15);
      padding: 20px;
      border-radius: 12px;
      font-size: 0.95em;
      margin-top: 25px;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }

    .sync-status {
      position: absolute;
      top: 10px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
    }

    .store-status {
      position: absolute;
      top: 10px;
      left: 20px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
    }

    /* Main content styles */
    .main-content {
      display: flex;
      padding: 30px;
      gap: 30px;
    }

    .form-section {
      flex: 3;
    }

    .sidebar {
      flex: 1;
      border-left: 1px solid #e0e0e0;
      padding-left: 30px;
      position: sticky;
      top: 30px;
      height: fit-content;
    }

    /* Shared Email Section */
    .shared-email {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.1) 100%);
      border: 2px solid #4caf50;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .shared-email h3 {
      color: #4caf50;
      margin-bottom: 15px;
      font-size: 1.2em;
      font-weight: 600;
    }

    /* Child Sections */
    .child-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .child-section:hover {
      border-color: #4285f4;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
    }

    .child-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .child-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
    }

    .child-icon {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .remove-child-btn {
      background: #ff5252;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .remove-child-btn:hover {
      background: #ff1744;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 82, 82, 0.3);
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-group {
      flex: 1;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
      font-size: 14px;
    }

    .required {
      color: #ff5252;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    /* Add Child Button */
    .add-child-btn {
      background: linear-gradient(135deg, #34a853 0%, #4caf50 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 30px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
    }

    .add-child-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
    }

    /* Menu Section */
    .menu-section {
      margin-top: 30px;
    }

    .menu-section h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.3em;
      font-weight: 600;
    }

    .day-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
      background: white;
    }

    .day-tab {
      padding: 15px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-weight: 500;
      color: #666;
      text-align: center;
      flex: 1;
      min-width: 100px;
    }

    .day-tab:hover {
      background: rgba(66, 133, 244, 0.05);
      color: #4285f4;
    }

    .day-tab.active {
      color: #4285f4;
      border-bottom-color: #4285f4;
      background: rgba(66, 133, 244, 0.05);
      font-weight: 600;
    }

    .day-tab.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      color: #999;
      background: #f5f5f5;
    }

    .menu-for-day {
      display: none;
    }

    .menu-for-day.active {
      display: block;
    }

    .menu-category {
      margin-bottom: 25px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .menu-category.collapsed .menu-items {
      display: none;
    }

    .menu-category-header {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      border-left: 4px solid #4caf50;
    }

    .menu-category-header:hover {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.1) 100%);
    }

    .menu-category-header h4 {
      color: #333;
      font-size: 1.2em;
      font-weight: 600;
      margin: 0;
    }

    .collapse-icon {
      color: #666;
      font-size: 18px;
      transition: transform 0.3s ease;
    }

    .menu-category.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .menu-items {
      padding: 20px;
      background: white;
    }

    .menu-item {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }

    .menu-item:hover {
      border-color: #4285f4;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
      background: white;
    }

    .menu-item-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid #e0e0e0;
    }

    .menu-item-content {
      flex: 1;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .item-name {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .item-price {
      color: #4caf50;
      font-weight: 700;
      font-size: 18px;
    }

    .item-desc {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .child-checkboxes {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .child-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
    }

    .child-checkbox:hover {
      border-color: #4285f4;
      background: rgba(66, 133, 244, 0.05);
    }

    .child-checkbox:has(input:checked) {
      background: linear-gradient(135deg, rgba(66, 133, 244, 0.1) 0%, rgba(66, 133, 244, 0.05) 100%);
      border-color: #4285f4;
    }

    .child-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .child-checkbox label {
      cursor: pointer;
      font-weight: 500;
      color: #333;
      font-size: 14px;
      margin: 0;
    }

    /* Cart Summary */
    .cart-summary {
      background: white;
      border: 2px solid #4285f4;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
    }

    .cart-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .empty-cart {
      text-align: center;
      color: #999;
      padding: 30px 0;
      font-style: italic;
    }

    .cart-items {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .cart-child-section {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .cart-child-section:last-child {
      border-bottom: none;
    }

    .cart-child-name {
      font-weight: 600;
      color: #4285f4;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .cart-item:hover {
      background: #e8f5e8;
    }

    .cart-item-content {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .cart-item-day {
      color: #666;
      font-size: 12px;
      margin-top: 2px;
    }

    .cart-item-price {
      font-weight: 600;
      color: #4caf50;
      margin-right: 10px;
    }

    .cart-item-price.discounted {
      color: #ff9800;
    }

    .remove-item-btn {
      background: none;
      border: none;
      color: #ff5252;
      cursor: pointer;
      font-size: 20px;
      padding: 0 5px;
      transition: all 0.3s ease;
    }

    .remove-item-btn:hover {
      transform: scale(1.2);
    }

    /* Promo Code Section */
    .promo-section {
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .promo-label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .promo-input-group {
      display: flex;
      gap: 10px;
    }

    .promo-input {
      flex: 1;
      padding: 10px;
      border: 2px solid #ff9800;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      transition: all 0.3s ease;
    }

    .promo-input:focus {
      outline: none;
      border-color: #ff9800;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .apply-promo-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .apply-promo-btn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }

    .promo-status {
      margin-top: 8px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
    }

    .promo-status.valid {
      color: #4caf50;
    }

    .promo-status.invalid {
      color: #f44336;
    }

    /* Cart Total Section */
    .cart-total {
      border-top: 2px solid #4285f4;
      padding-top: 15px;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .total-row span:first-child {
      color: #666;
    }

    .total-row span:last-child {
      font-weight: 600;
      color: #333;
    }

    .total-row.discount {
      color: #ff9800;
    }

    .total-row.final {
      font-size: 18px;
      font-weight: 700;
      color: #4285f4;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
    }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 10002;
      animation: slideIn 0.3s ease;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification.success {
      background: #4caf50;
      color: white;
    }

    .notification.error {
      background: #f44336;
      color: white;
    }

    .notification.info {
      background: #2196f3;
      color: white;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .auth-user-bar {
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding: 15px;
      }

      .main-content {
        flex-direction: column;
      }

      .form-section, .sidebar {
        flex: none;
      }

      .sidebar {
        border-left: none;
        border-top: 1px solid #e0e0e0;
        padding-left: 0;
        padding-top: 30px;
      }

      .form-row {
        flex-direction: column;
        gap: 15px;
      }

      .day-tabs {
        overflow-x: scroll;
      }

      .child-checkboxes {
        flex-direction: column;
      }

      .header-brand {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .header-text {
        text-align: center;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .header .subtitle {
        font-size: 1em;
      }

      .artios-logo {
        width: 50px;
        height: 50px;
      }

      .sync-status, .store-status {
        position: relative;
        top: auto;
        left: auto;
        right: auto;
        display: inline-block;
        margin: 5px;
      }

      .menu-item {
        flex-direction: column;
        gap: 10px;
      }

      .menu-item-image {
        width: 100%;
        height: 150px;
        align-self: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <!-- Authentication user bar will be inserted here by JavaScript -->
      
      <div class="store-status" id="store-status">
        Checking store hours...
      </div>
      <div class="sync-status">
        ‚òÅÔ∏è Cloud Sync Active
      </div>
      
      <div class="header-brand">
        <img class="artios-logo" src="artios-logo.png" alt="Artios Academies Logo">
        <div class="header-text">
          <h1>Artios Academies of Sugar Hill</h1>
          <div class="subtitle">Cafe Lunch Order System 2025-2026</div>
        </div>
      </div>
      
      <div class="notice">
        <strong>Order & Payment Cutoff: Daily at 8:00 AM</strong><br>
        ONE FORM PER FAMILY ‚Ä¢ Order for multiple children with one email<br>
        Form closed daily from 8:00 AM - 1:00 PM<br>
        Contact: CRivers@artiosacademies.com | Artios Academies of Sugar Hill
      </div>
    </div>

    <div class="main-content">
      <div class="form-section">
        <!-- Shared Email Section -->
        <div class="shared-email">
          <h3>üìß Family Email</h3>
          <div class="form-group">
            <label for="family-email">Email Address <span class="required">*</span></label>
            <input type="email" id="family-email" required placeholder="parent@example.com">
          </div>
        </div>

        <!-- Children Sections -->
        <div id="children-container">
          <div class="child-section" data-child="1">
            <div class="child-header">
              <div class="child-title">
                <div class="child-icon">1</div>
                Child 1
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>First Name <span class="required">*</span></label>
                <input type="text" class="child-first-name" required>
              </div>
              <div class="form-group">
                <label>Last Name <span class="required">*</span></label>
                <input type="text" class="child-last-name" required>
              </div>
              <div class="form-group">
                <label>Grade <span class="required">*</span></label>
                <select class="child-grade" required>
                  <option value="">Select Grade</option>
                  <option value="K-2">K-2</option>
                  <option value="3-4">3-4</option>
                  <option value="5-6">5-6</option>
                  <option value="7-8">7-8</option>
                  <option value="9-12">9-12</option>
                  <option value="Staff">Staff</option>
                  <option value="Parent">Parent</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="add-child-btn" id="add-child-btn">
          <span>‚ûï</span> Add Another Child
        </button>

        <div class="menu-section">
          <h3>Select Days & Menu Items</h3>

          <div class="day-tabs" id="day-tabs">
            <!-- Tabs will be generated by JavaScript -->
          </div>

          <div id="menu-container">
            <!-- Menu for each day will be generated by JavaScript -->
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="cart-summary">
          <div class="cart-title">üõí Your Order</div>

          <div class="cart-items" id="cart-items">
            <div class="empty-cart">No items selected</div>
          </div>

          <div class="promo-section">
            <label class="promo-label">üéâ Discount Code</label>
            <div class="promo-input-group">
              <input type="text" id="discount-code" class="promo-input" placeholder="Enter code">
              <button class="apply-promo-btn" onclick="applyDiscountCode()">Apply</button>
            </div>
            <div id="discount-message" class="promo-status"></div>
          </div>

          <div class="cart-total">
            <div class="total-row">
              <span>Subtotal:</span>
              <span>$<span id="subtotal-amount">0.00</span></span>
            </div>
            <div class="total-row discount" id="discount-row" style="display: none;">
              <span>Discount:</span>
              <span>-$<span id="discount-amount">0.00</span></span>
            </div>
            <div class="total-row final">
              <span>Total:</span>
              <span>$<span id="total-amount">0.00</span></span>
            </div>
          </div>

          <button class="submit-btn" id="submit-order-btn" onclick="submitOrder()" disabled>
            Place Order via Venmo
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="notification" id="notification" style="display: none;"></div>

  <script>
    // ============================================
    // AUTHENTICATION CHECK
    // ============================================
    let authenticatedEmail = '';
    
    // Check authentication immediately on page load
    (function checkAuthenticationOnLoad() {
      authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
      const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
      
      console.log('üîê Checking authentication for ordering...');
      console.log('Email:', authenticatedEmail);
      console.log('Expiry:', authExpiry ? new Date(authExpiry) : 'None');
      
      if (!authenticatedEmail || !authExpiry || Date.now() >= authExpiry) {
        console.log('‚ùå No valid authentication - redirecting to login');
        redirectToLogin();
      } else {
        console.log('‚úÖ Authentication valid for ordering');
        setupAuthenticatedUI();
      }
    })();

    function redirectToLogin() {
      sessionStorage.removeItem('authenticatedEmail');
      sessionStorage.removeItem('authExpiry');
      
      document.body.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: Arial, sans-serif;">
          <div style="text-align: center; background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px;">
            <div style="font-size: 4em; margin-bottom: 20px;">üîí</div>
            <h2 style="color: #4285f4; margin-bottom: 15px; font-size: 2em;">Login Required</h2>
            <p style="color: #666; margin-bottom: 25px; font-size: 1.1em;">Please login to access the cafe ordering system</p>
            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
              <h4 style="color: #1976d2; margin-bottom: 10px;">üîê Secure Family Portal</h4>
              <ul style="margin: 0; padding-left: 20px; color: #333; font-size: 0.9em;">
                <li>Your order history is private and protected</li>
                <li>Quick access to manage your family orders</li>
                <li>Secure checkout with saved family info</li>
              </ul>
            </div>
            <div style="font-size: 14px; color: #999; margin-top: 20px;">Redirecting to login in 3 seconds...</div>
          </div>
        </div>
      `;
      
      setTimeout(() => { window.location.href = 'login.html'; }, 3000);
    }

    function setupAuthenticatedUI() {
      const header = document.querySelector('.header');
      if (header) {
        const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
        const timeLeft = Math.floor((authExpiry - Date.now()) / (1000 * 60 * 60));
        
        const userInfoBar = document.createElement('div');
        userInfoBar.className = 'auth-user-bar';
        userInfoBar.innerHTML = `
          <div style="display: flex; align-items: center; gap: 15px;">
            <span style="opacity: 0.9;">üîì Logged in as:</span>
            <span style="font-weight: 600;">${authenticatedEmail}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 15px;">
            <a href="dashboard.html" style="color: white; text-decoration: none; opacity: 0.9; font-weight: 500;">üìä Dashboard</a>
            <span style="opacity: 0.8;">${timeLeft}h session</span>
            <button onclick="logout()" class="logout-btn">
              Logout
            </button>
          </div>
        `;
        
        // Insert at the top of the header
        header.insertBefore(userInfoBar, header.firstChild);
      }
      
      // Pre-fill and lock the email field
      setTimeout(() => {
        const emailField = document.getElementById('family-email');
        if (emailField) {
          emailField.value = authenticatedEmail;
          emailField.readOnly = true;
          emailField.style.background = '#f0f9ff';
          emailField.style.cursor = 'not-allowed';
          
          const emailGroup = emailField.closest('.form-group');
          if (emailGroup && !emailGroup.querySelector('small')) {
            const emailNote = document.createElement('small');
            emailNote.style.cssText = 'color: #666; font-style: italic; margin-top: 5px; display: block;';
            emailNote.textContent = 'Email is locked to your authenticated account for security';
            emailGroup.appendChild(emailNote);
          }
        }
      }, 100);
    }

    function logout() {
      if (confirm('Are you sure you want to logout? Any unsaved order progress will be lost.')) {
        sessionStorage.removeItem('authenticatedEmail');
        sessionStorage.removeItem('authExpiry');
        window.location.href = 'login.html';
      }
    }

    // ============================================
    // CONFIGURATION
    // ============================================
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec',
      useGoogleSheets: true
    };

    // ============================================
    // MENU DATA
    // ============================================
    const menuData = {
      entrees: [
        { id: 'chicken-sandwich', name: 'Chicken Sandwich', price: 6.50, desc: 'Classic boneless breast of chicken', image: 'assets/chickensandwich.png' },
        { id: 'spicy-chicken', name: 'Spicy Chicken Sandwich', price: 6.75, desc: 'Boneless breast with spicy seasoning', image: 'assets/spicysandwich.png' },
        { id: 'nuggets-8', name: 'Nuggets (8ct)', price: 6.50, desc: 'Bite-sized boneless chicken pieces', image: 'assets/nuggets.png' },
        { id: 'grilled-nuggets', name: 'Grilled Nuggets (8ct)', price: 7.50, desc: 'Grilled boneless chicken pieces', image: 'assets/grillednuggets.png' },
        { id: 'grilled-sandwich', name: 'Grilled Sandwich', price: 8.25, desc: 'Grilled chicken breast sandwich', image: 'assets/grilledsandwich.png' },
        { id: 'grilled-gf', name: 'Grilled Sandwich (GF Bun)', price: 9.50, desc: 'Grilled chicken with gluten-free bun', image: 'assets/grilledsandwich.png' },
        { id: 'chicken-wrap', name: 'Chicken Wrap', price: 9.75, desc: 'Grilled chicken in tortilla wrap', image: 'assets/chickenwrap.png' },
        { id: 'veggie-wrap', name: 'Southwest Veggie Wrap', price: 9.50, desc: 'Vegetarian wrap with southwest flavors', image: 'assets/veggiewrap.png' },
        { id: 'chicken-strips', name: 'Chicken Strips (3ct)', price: 6.75, desc: 'Hand-breaded chicken strips', image: 'assets/chickenstrips.png' }
      ],
      salads: [
        { id: 'cobb-salad', name: 'Cobb Salad', price: 10.25, desc: 'Fresh greens with grilled chicken', image: 'assets/cobbsalad.png' },
        { id: 'southwest-salad', name: 'Southwest Salad', price: 10.25, desc: 'Spicy southwest-style salad', image: 'assets/southwestsalad.png' },
        { id: 'market-salad', name: 'Market Salad', price: 10.25, desc: 'Fresh seasonal market vegetables', image: 'assets/marketsalad.png' }
      ],
      sides: [
        { id: 'waffle-fries', name: 'Waffle Fries', price: 3.00, desc: 'Crispy waffle-cut potatoes', image: 'assets/wafflefries.png' },
        { id: 'fruit-cup', name: 'Fruit Cup', price: 3.75, desc: 'Fresh seasonal fruit mix', image: 'assets/fruitcup.png' },
        { id: 'mac-cheese', name: 'Mac & Cheese', price: 3.75, desc: 'Creamy macaroni and cheese', image: 'assets/maccheese.png' },
        { id: 'side-salad', name: 'Side Salad', price: 3.75, desc: 'Fresh garden salad', image: 'assets/sidesalad.png' },
        { id: 'parfait', name: 'Greek Yogurt Parfait', price: 4.25, desc: 'Yogurt with granola and berries', image: 'assets/parfait.png' },
        { id: 'chips', name: 'Chips', price: 1.50, desc: 'Individual bag of chips (Artios-provided)', image: 'assets/chips.png' }
      ],
      drinks: [
        { id: 'lemonade', name: 'Lemonade', basePrice: 1.50, category: 'regular', desc: 'Classic fresh lemonade' },
        { id: 'sweet-tea', name: 'Sweet Tea', basePrice: 1.50, category: 'regular', desc: 'Southern-style sweet tea' },
        { id: 'unsweet-tea', name: 'Unsweet Tea', basePrice: 1.50, category: 'regular', desc: 'Fresh brewed unsweetened tea' },
        { id: 'coke', name: 'Coca-Cola', basePrice: 1.50, category: 'regular', desc: 'Classic Coca-Cola' },
        { id: 'sprite', name: 'Sprite', basePrice: 1.50, category: 'regular', desc: 'Lemon-lime soda' },
        { id: 'dr-pepper', name: 'Dr Pepper', basePrice: 1.50, category: 'regular', desc: '23 flavors of deliciousness' },
        { id: 'root-beer', name: 'Root Beer', basePrice: 1.50, category: 'regular', desc: 'Classic root beer' },
        { id: 'apple-juice', name: 'Apple Juice', basePrice: 1.50, category: 'regular', desc: '100% apple juice' },
        { id: 'orange-juice', name: 'Orange Juice', basePrice: 1.50, category: 'regular', desc: '100% orange juice' },
        { id: 'frosted-lemonade', name: 'Frosted Lemonade', basePrice: 3.00, category: 'premium', desc: 'Creamy frozen lemonade treat' },
        { id: 'frosted-coffee', name: 'Frosted Coffee', basePrice: 3.00, category: 'premium', desc: 'Iced coffee blended treat' },
        { id: 'chocolate-milk', name: 'Chocolate Milk', basePrice: 3.00, category: 'premium', desc: 'Rich chocolate milk' },
        { id: 'coffee', name: 'Coffee', basePrice: 3.00, category: 'premium', desc: 'Freshly brewed coffee' }
      ]
    };

    // ============================================
    // GLOBAL VARIABLES
    // ============================================
    let childCount = 1;
    let currentDay = 'monday';
    let currentWeekMonday = null;
    let isNextWeek = false;
    let orderItems = [];
    let currentSubtotal = 0;
    let currentDiscount = 0;
    let currentTotal = 0;
    let discountType = null;
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      if (authenticatedEmail) {
        initializeApp();
        loadSavedData();
      }
    });

    function initializeApp() {
      checkStoreHours();
      generateDayTabs();
      generateMenus();
      setupEventListeners();
      setInterval(checkStoreHours, 60000);
    }

    function setupEventListeners() {
      document.getElementById('add-child-btn').addEventListener('click', addChild);
      
      document.getElementById('family-email').addEventListener('input', function() {
        saveDataToCookies();
        validateForm();
      });

      document.getElementById('children-container').addEventListener('input', function(e) {
        if (e.target.classList.contains('child-first-name') || 
            e.target.classList.contains('child-last-name') || 
            e.target.classList.contains('child-grade')) {
          saveDataToCookies();
          updateChildCheckboxes();
          updateCart();
          validateForm();
        }
      });

      document.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' && e.target.dataset.item) {
          updateCart();
          saveDataToCookies();
        }
      });
    }

    // ============================================
    // STORE HOURS MANAGEMENT
    // ============================================
    function checkStoreHours() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const dayOfWeek = now.getDay();
      const storeStatus = document.getElementById('store-status');
      
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
      const isPastCutoff = (hours > 8) || (hours === 8 && minutes >= 15);
      const isBeforeReopen = hours < 13;
      const isFridayAfterNoon = (dayOfWeek === 5 && hours >= 12);
      
      if (dayOfWeek === 5 && hours >= 12) {
        isNextWeek = true;
      } else if (dayOfWeek === 0 || dayOfWeek === 6) {
        isNextWeek = false;
      }
      
      if (isWeekday && isPastCutoff && isBeforeReopen && !isFridayAfterNoon) {
        storeStatus.style.background = 'rgba(255, 82, 82, 0.8)';
        storeStatus.textContent = 'üîí Orders Closed Until 1:00 PM';
        disableOrdering();
      } else {
        const statusText = isWeekday ? '‚úÖ Store Open - Orders Accepted' : '‚úÖ Weekend Ordering Open';
        storeStatus.textContent = statusText;
        storeStatus.style.background = 'rgba(76, 175, 80, 0.8)';
      }
    }

    function disableOrdering() {
      const orderBtn = document.getElementById('submit-order-btn');
      if (orderBtn) {
        orderBtn.disabled = true;
        orderBtn.textContent = 'Ordering Closed (Reopens 1 PM)';
      }
    }

    // ============================================
    // DAY TAB GENERATION
    // ============================================
    function generateDayTabs() {
      const tabsContainer = document.getElementById('day-tabs');
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinutes = now.getMinutes();
      let firstAvailableDay = null;

      let monday;
      if (isNextWeek) {
        monday = getNextMonday(now);
      } else {
        monday = getCurrentWeekMonday(now);
      }
      currentWeekMonday = monday;

      days.forEach(function(day, index) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + index);
        
        const tab = document.createElement('div');
        tab.className = 'day-tab';
        tab.dataset.day = day;
        
        const dayName = day.charAt(0).toUpperCase() + day.slice(1);
        const dateStr = (date.getMonth() + 1) + '/' + date.getDate();
        
        const today = new Date();
        const isPast = date < today && date.toDateString() !== today.toDateString();
        const isToday = date.toDateString() === today.toDateString();
        const isPastCutoff = isToday && ((currentHour > 8) || (currentHour === 8 && currentMinutes >= 15));
        
        tab.innerHTML = dayName + '<br><small>' + dateStr + '</small>';
        
        if (isPast || isPastCutoff) {
          tab.classList.add('disabled');
          tab.title = isPastCutoff ? 'Past 8:15 AM cutoff' : 'Past date';
        } else {
          if (!firstAvailableDay) {
            firstAvailableDay = day;
            tab.classList.add('active');
            currentDay = day;
          }
          tab.addEventListener('click', function() {
            switchDay(day);
          });
        }
        
        tabsContainer.appendChild(tab);
      });

      const weekIndicator = document.createElement('div');
      weekIndicator.style.cssText = 'margin-left: auto; padding: 15px; font-weight: 600; color: #4285f4;';
      weekIndicator.textContent = isNextWeek ? 'Next Week' : 'This Week';
      tabsContainer.appendChild(weekIndicator);
    }

    function getCurrentWeekMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getNextMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() + (8 - day);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // ============================================
    // MENU GENERATION
    // ============================================
    function generateMenus() {
      const container = document.getElementById('menu-container');
      
      days.forEach(function(day) {
        const dayMenu = document.createElement('div');
        dayMenu.className = 'menu-for-day';
        dayMenu.dataset.day = day;
        
        if (day === currentDay) {
          dayMenu.classList.add('active');
        }
        
        Object.keys(menuData).forEach(function(category) {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'menu-category';
          categoryDiv.dataset.category = category;
          
          let categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
          
          const headerDiv = document.createElement('div');
          headerDiv.className = 'menu-category-header';
          headerDiv.innerHTML = `
            <h4>${categoryTitle}</h4>
            <span class="collapse-icon">‚ñº</span>
          `;
          
          const itemsDiv = document.createElement('div');
          itemsDiv.className = 'menu-items';
          
          if (category === 'drinks') {
            const discountNotice = document.createElement('div');
            discountNotice.style.cssText = 'background: #e8f5e8; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #34a853;';
            discountNotice.innerHTML = '<strong>üí° Combo Meal Drink Discount!</strong><br>Order an <strong>Entree or Salad + Side</strong> to get drink discounts applied in your cart!<br>‚Ä¢ Regular Drink = <strong>FREE!</strong><br>‚Ä¢ Premium Drink = <strong>$1.50</strong> (save $1.50!)';
            itemsDiv.appendChild(discountNotice);
          }
          
          menuData[category].forEach(function(item) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item';
            
            let priceDisplay;
            if (category === 'drinks') {
              priceDisplay = '$' + item.basePrice.toFixed(2);
            } else {
              priceDisplay = '$' + item.price.toFixed(2);
            }
            
            let imageHtml = '';
            if (category !== 'drinks' && item.image) {
              imageHtml = `<img src="${item.image}" alt="${item.name}" class="menu-item-image" onerror="this.style.display='none'">`;
            }
            
            itemDiv.innerHTML = `
              ${imageHtml}
              <div class="menu-item-content">
                <div class="item-header">
                  <div class="item-name">${item.name}</div>
                  <div class="item-price" data-item-id="${item.id}">${priceDisplay}</div>
                </div>
                <div class="item-desc">${item.desc}</div>
                <div class="child-checkboxes" id="${item.id}-${day}-checkboxes"></div>
              </div>
            `;
            
            itemsDiv.appendChild(itemDiv);
          });
          
          categoryDiv.appendChild(headerDiv);
          categoryDiv.appendChild(itemsDiv);
          
          setupCategoryToggle(categoryDiv, category);
          
          dayMenu.appendChild(categoryDiv);
        });
        
        container.appendChild(dayMenu);
      });
      
      updateChildCheckboxes();
    }

    function setupCategoryToggle(categoryDiv, categoryId) {
      const header = categoryDiv.querySelector('.menu-category-header');
      header.addEventListener('click', function() {
        categoryDiv.classList.toggle('collapsed');
      });
    }

    function switchDay(day) {
      document.querySelectorAll('.day-tab').forEach(function(tab) {
        tab.classList.remove('active');
        if (tab.dataset.day === day) {
          tab.classList.add('active');
        }
      });

      document.querySelectorAll('.menu-for-day').forEach(function(menu) {
        menu.classList.remove('active');
        if (menu.dataset.day === day) {
          menu.classList.add('active');
        }
      });

      currentDay = day;
    }

    // ============================================
    // CHILD MANAGEMENT
    // ============================================
    function addChild() {
      childCount++;
      const container = document.getElementById('children-container');
      
      const childSection = document.createElement('div');
      childSection.className = 'child-section';
      childSection.dataset.child = childCount;
      
      childSection.innerHTML = `
        <div class="child-header">
          <div class="child-title">
            <div class="child-icon">${childCount}</div>
            Child ${childCount}
          </div>
          <button type="button" class="remove-child-btn" onclick="removeChild(${childCount})">Remove</button>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>First Name <span class="required">*</span></label>
            <input type="text" class="child-first-name" required>
          </div>
          <div class="form-group">
            <label>Last Name <span class="required">*</span></label>
            <input type="text" class="child-last-name" required>
          </div>
          <div class="form-group">
            <label>Grade <span class="required">*</span></label>
            <select class="child-grade" required>
              <option value="">Select Grade</option>
              <option value="K-2">K-2</option>
              <option value="3-4">3-4</option>
              <option value="5-6">5-6</option>
              <option value="7-8">7-8</option>
              <option value="9-12">9-12</option>
              <option value="Staff">Staff</option>
              <option value="Parent">Parent</option>
            </select>
          </div>
        </div>
      `;
      
      container.appendChild(childSection);
      updateChildCheckboxes();
      showNotification('Child ' + childCount + ' added!', 'success');
    }

    function removeChild(childId) {
      const childSection = document.querySelector('[data-child="' + childId + '"]');
      if (childSection) {
        childSection.remove();
        updateChildCheckboxes();
        updateCart();
        showNotification('Child removed', 'info');
      }
    }

    function updateChildCheckboxes() {
      const children = document.querySelectorAll('.child-section');
      
      document.querySelectorAll('.child-checkboxes').forEach(function(container) {
        container.innerHTML = '';
      });
      
      children.forEach(function(child) {
        const childId = child.dataset.child;
        const firstName = child.querySelector('.child-first-name').value;
        const lastName = child.querySelector('.child-last-name').value;
        const grade = child.querySelector('.child-grade').value;
        
        if (firstName && lastName && grade) {
          const childName = firstName + ' ' + lastName.charAt(0) + '.';
          
          days.forEach(function(day) {
            Object.keys(menuData).forEach(function(category) {
              menuData[category].forEach(function(item) {
                const checkboxContainer = document.getElementById(item.id + '-' + day + '-checkboxes');
                if (checkboxContainer) {
                  const existingCheckbox = checkboxContainer.querySelector('[data-child-id="' + childId + '"]');
                  if (!existingCheckbox) {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'child-checkbox';
                    
                    const checkboxId = item.id + '-' + day + '-' + childId;
                    checkboxDiv.innerHTML = `
                      <input type="checkbox" id="${checkboxId}" 
                             data-item="${item.id}" 
                             data-day="${day}" 
                             data-child-id="${childId}">
                      <label for="${checkboxId}">${childName}</label>
                    `;
                    
                    checkboxContainer.appendChild(checkboxDiv);
                  }
                }
              });
            });
          });
        }
      });
    }

    // ============================================
    // CART MANAGEMENT
    // ============================================
    function updateCart() {
      orderItems = [];
      currentSubtotal = 0;
      const childDayDrinks = {};
      
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(function(checkbox) {
        const itemId = checkbox.dataset.item;
        const day = checkbox.dataset.day;
        const childId = checkbox.dataset.childId;
        
        const child = document.querySelector('[data-child="' + childId + '"]');
        if (!child) return;
        
        const childFirstName = child.querySelector('.child-first-name').value;
        const childLastName = child.querySelector('.child-last-name').value;
        const childGrade = child.querySelector('.child-grade').value;
        
        let item = null;
        let category = null;
        Object.keys(menuData).forEach(function(cat) {
          const found = menuData[cat].find(function(i) { return i.id === itemId; });
          if (found) {
            item = found;
            category = cat;
          }
        });
        
        if (item) {
          let finalPrice = item.price || item.basePrice;
          let isDiscounted = false;
          let discountAmount = 0;
          
          if (category === 'drinks') {
            const hasEntreeOrSaladAndSide = checkChildHasEntreeOrSaladAndSide(childId, day);
            const childDayKey = childId + '-' + day;
            
            if (!childDayDrinks[childDayKey]) {
              childDayDrinks[childDayKey] = { discountedDrinks: 0, hasCombo: hasEntreeOrSaladAndSide };
            }
            
            if (hasEntreeOrSaladAndSide && childDayDrinks[childDayKey].discountedDrinks === 0) {
              if (item.category === 'regular') {
                discountAmount = item.basePrice;
                finalPrice = 0;
                isDiscounted = true;
              } else if (item.category === 'premium') {
                discountAmount = item.basePrice - 1.50;
                finalPrice = 1.50;
                isDiscounted = true;
              }
              childDayDrinks[childDayKey].discountedDrinks++;
            } else {
              finalPrice = item.basePrice;
            }
          }
          
          const orderItem = {
            itemId: itemId,
            childId: childId,
            childName: childFirstName + ' ' + childLastName,
            firstName: childFirstName,
            lastName: childLastName,
            grade: childGrade,
            name: item.name,
            price: finalPrice,
            originalPrice: item.price || item.basePrice,
            day: day.charAt(0).toUpperCase() + day.slice(1),
            category: category,
            isDiscounted: isDiscounted,
            discountAmount: discountAmount
          };
          
          orderItems.push(orderItem);
          currentSubtotal += finalPrice;
        }
      });
      
      if (discountType === 'staff') {
        currentDiscount = currentSubtotal * 0.10;
      } else if (discountType === 'john') {
        currentDiscount = currentSubtotal * 0.50;
      } else {
        currentDiscount = 0;
      }
      
      currentTotal = currentSubtotal - currentDiscount;
      
      displayCart();
      validateForm();
    }

    function checkChildHasEntreeOrSaladAndSide(childId, day) {
      let hasEntreeOrSalad = false;
      let hasSide = false;
      
      document.querySelectorAll('input[type="checkbox"][data-child-id="' + childId + '"][data-day="' + day + '"]:checked').forEach(function(checkbox) {
        const itemId = checkbox.dataset.item;
        
        Object.keys(menuData).forEach(function(category) {
          const found = menuData[category].find(function(i) { return i.id === itemId; });
          if (found) {
            if (category === 'entrees' || category === 'salads') {
              hasEntreeOrSalad = true;
            } else if (category === 'sides') {
              hasSide = true;
            }
          }
        });
      });
      
      return hasEntreeOrSalad && hasSide;
    }

    function displayCart() {
      const cartItemsDiv = document.getElementById('cart-items');
      const totalSpan = document.getElementById('total-amount');
      const subtotalSpan = document.getElementById('subtotal-amount');
      const discountSpan = document.getElementById('discount-amount');
      const discountRow = document.getElementById('discount-row');
      
      if (orderItems.length === 0) {
        cartItemsDiv.innerHTML = '<div class="empty-cart">No items selected</div>';
        totalSpan.textContent = '0.00';
        subtotalSpan.textContent = '0.00';
        return;
      }
      
      const itemsByChild = {};
      orderItems.forEach(function(item) {
        if (!itemsByChild[item.childId]) {
          itemsByChild[item.childId] = {
            name: item.childName,
            items: []
          };
        }
        itemsByChild[item.childId].items.push(item);
      });
      
      let html = '';
      Object.keys(itemsByChild).sort(function(a, b) {
        return parseInt(a) - parseInt(b);
      }).forEach(function(childId) {
        const child = itemsByChild[childId];
        html += '<div class="cart-child-section">';
        html += '<div class="cart-child-name">' + child.name + '</div>';
        
        child.items.forEach(function(item) {
          const priceClass = item.isDiscounted ? 'discounted' : '';
          const priceText = item.price === 0 ? 'FREE!' : ' + item.price.toFixed(2);
          const originalPriceText = item.isDiscounted ? ' (was  + item.originalPrice.toFixed(2) + ')' : '';
          
          html += `
            <div class="cart-item">
              <div class="cart-item-content">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-day">${item.day}</div>
              </div>
              <div class="cart-item-price ${priceClass}">${priceText}${originalPriceText}</div>
              <button class="remove-item-btn" onclick="removeItemFromCart('${item.itemId}', '${item.childId}', '${item.day.toLowerCase()}')" title="Remove item">√ó</button>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      cartItemsDiv.innerHTML = html;
      subtotalSpan.textContent = currentSubtotal.toFixed(2);
      
      if (currentDiscount > 0) {
        discountRow.style.display = 'flex';
        discountSpan.textContent = currentDiscount.toFixed(2);
      } else {
        discountRow.style.display = 'none';
      }
      
      totalSpan.textContent = currentTotal.toFixed(2);
    }

    function removeItemFromCart(itemId, childId, day) {
      const checkbox = document.querySelector(
        `input[type="checkbox"][data-item="${itemId}"][data-child-id="${childId}"][data-day="${day}"]`
      );
      
      if (checkbox) {
        checkbox.checked = false;
        updateCart();
        showNotification('Item removed from cart', 'info');
      }
    }

    // ============================================
    // DISCOUNT MANAGEMENT
    // ============================================
    function applyDiscountCode() {
      const codeInput = document.getElementById('discount-code');
      const messageDiv = document.getElementById('discount-message');
      const code = codeInput.value.trim().toUpperCase();
      
      messageDiv.style.opacity = '0';
      
      if (!code) {
        messageDiv.className = 'promo-status invalid';
        messageDiv.textContent = 'Please enter a discount code';
        messageDiv.style.opacity = '1';
        return;
      }
      
      if (code === 'STAFF2025') {
        discountType = 'staff';
        messageDiv.className = 'promo-status valid';
        messageDiv.textContent = '‚úÖ Staff discount applied! (10% off)';
        messageDiv.style.opacity = '1';
        codeInput.disabled = true;
      } else if (code === 'JOHN') {
        discountType = 'john';
        messageDiv.className = 'promo-status valid';
        messageDiv.textContent = '‚úÖ Special discount applied! (50% off)';
        messageDiv.style.opacity = '1';
        codeInput.disabled = true;
      } else {
        discountType = null;
        messageDiv.className = 'promo-status invalid';
        messageDiv.textContent = '‚ùå Invalid discount code';
        messageDiv.style.opacity = '1';
      }
      
      updateCart();
    }

    // ============================================
    // FORM VALIDATION
    // ============================================
    function validateForm() {
      const email = document.getElementById('family-email').value;
      const submitBtn = document.getElementById('submit-order-btn');
      
      let isValid = true;
      let hasCompleteChild = false;
      
      if (!email) {
        isValid = false;
      }
      
      document.querySelectorAll('.child-section').forEach(function(child) {
        const firstName = child.querySelector('.child-first-name').value;
        const lastName = child.querySelector('.child-last-name').value;
        const grade = child.querySelector('.child-grade').value;
        
        if (firstName && lastName && grade) {
          hasCompleteChild = true;
        }
      });
      
      if (!hasCompleteChild) {
        isValid = false;
      }
      
      if (orderItems.length === 0) {
        isValid = false;
      }
      
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const dayOfWeek = now.getDay();
      const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
      const isPastCutoff = (hours > 8) || (hours === 8 && minutes >= 15);
      const isBeforeReopen = hours < 13;
      const isFridayAfterNoon = (dayOfWeek === 5 && hours >= 12);
      
      if (isWeekday && isPastCutoff && isBeforeReopen && !isFridayAfterNoon) {
        isValid = false;
        submitBtn.textContent = 'Ordering Closed (Reopens 1 PM)';
      } else if (isValid) {
        submitBtn.textContent = 'Place Order via Venmo';
      }
      
      submitBtn.disabled = !isValid;
    }

    // ============================================
    // ORDER SUBMISSION
    // ============================================
    function submitOrder() {
      const email = document.getElementById('family-email').value;
      
      if (!email || orderItems.length === 0) {
        showNotification('Please complete all required fields and select items', 'error');
        return;
      }
      
      const venmoUsername = '@ChanTa-Rivers';
      const orderDescription = generateOrderDescription();
      const venmoUrl = 'https://venmo.com/' + venmoUsername + '?txn=pay&amount=' + currentTotal.toFixed(2) + '&note=' + encodeURIComponent(orderDescription);
      
      showNotification('Processing your order...', 'info');
      
      if (GOOGLE_SHEETS_CONFIG.useGoogleSheets) {
        sendToGoogleSheets();
      }
      
      setTimeout(function() {
        window.open(venmoUrl, '_blank');
        showNotification('Redirecting to Venmo for payment...', 'success');
      }, 1000);
    }

    function generateOrderDescription() {
      let description = 'Artios Cafe Order - ';
      const childNames = new Set();
      
      orderItems.forEach(function(item) {
        childNames.add(item.firstName);
      });
      
      description += Array.from(childNames).join(', ');
      
      if (currentWeekMonday) {
        const weekStart = (currentWeekMonday.getMonth() + 1) + '/' + currentWeekMonday.getDate();
        description += ' - Week of ' + weekStart;
      }
      
      return description;
    }

    function sendToGoogleSheets() {
      const email = document.getElementById('family-email').value;
      const children = [];
      
      document.querySelectorAll('.child-section').forEach(function(child) {
        const firstName = child.querySelector('.child-first-name').value;
        const lastName = child.querySelector('.child-last-name').value;
        const grade = child.querySelector('.child-grade').value;
        
        if (firstName && lastName && grade) {
          children.push({
            firstName: firstName,
            lastName: lastName,
            grade: grade
          });
        }
      });
      
      const orderData = {
        timestamp: new Date().toISOString(),
        email: email,
        children: children,
        items: orderItems,
        subtotal: currentSubtotal,
        discount: currentDiscount,
        discountType: discountType,
        total: currentTotal,
        weekMonday: currentWeekMonday ? currentWeekMonday.toISOString() : null,
        isNextWeek: isNextWeek
      };
      
      fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(orderData)
      })
      .then(function() {
        console.log('Order sent to Google Sheets');
        clearSavedData();
      })
      .catch(function(error) {
        console.error('Error sending to Google Sheets:', error);
      });
    }

    // ============================================
    // DATA PERSISTENCE
    // ============================================
    function saveDataToCookies() {
      const data = {
        email: document.getElementById('family-email').value,
        children: [],
        selectedItems: []
      };
      
      document.querySelectorAll('.child-section').forEach(function(child) {
        data.children.push({
          id: child.dataset.child,
          firstName: child.querySelector('.child-first-name').value,
          lastName: child.querySelector('.child-last-name').value,
          grade: child.querySelector('.child-grade').value
        });
      });
      
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(function(checkbox) {
        data.selectedItems.push({
          item: checkbox.dataset.item,
          day: checkbox.dataset.day,
          childId: checkbox.dataset.childId
        });
      });
      
      localStorage.setItem('artioscafe_order', JSON.stringify(data));
    }

    function loadSavedData() {
      try {
        const savedData = localStorage.getItem('artioscafe_order');
        if (!savedData) return;
        
        const data = JSON.parse(savedData);
        
        // Don't load the saved email - use the authenticated one
        // Email is already pre-filled by setupAuthenticatedUI()
        
        // Load children
        if (data.children && data.children.length > 0) {
          // Clear existing children except the first
          document.querySelectorAll('.child-section:not(:first-child)').forEach(function(child) {
            child.remove();
          });
          
          data.children.forEach(function(childData, index) {
            if (index === 0) {
              // Update first child
              const firstChild = document.querySelector('.child-section');
              if (firstChild) {
                firstChild.querySelector('.child-first-name').value = childData.firstName || '';
                firstChild.querySelector('.child-last-name').value = childData.lastName || '';
                firstChild.querySelector('.child-grade').value = childData.grade || '';
              }
            } else {
              // Add additional children
              addChild();
              const newChild = document.querySelector('[data-child="' + (index + 1) + '"]');
              if (newChild) {
                newChild.querySelector('.child-first-name').value = childData.firstName || '';
                newChild.querySelector('.child-last-name').value = childData.lastName || '';
                newChild.querySelector('.child-grade').value = childData.grade || '';
              }
            }
          });
          
          updateChildCheckboxes();
          
          // Restore selected items after checkboxes are created
          setTimeout(function() {
            if (data.selectedItems) {
              data.selectedItems.forEach(function(item) {
                const checkbox = document.querySelector(
                  'input[type="checkbox"][data-item="' + item.item + '"][data-day="' + item.day + '"][data-child-id="' + item.childId + '"]'
                );
                if (checkbox) {
                  checkbox.checked = true;
                }
              });
              updateCart();
            }
          }, 100);
        }
      } catch (error) {
        console.error('Error loading saved data:', error);
      }
    }

    function clearSavedData() {
      localStorage.removeItem('artioscafe_order');
    }

    // ============================================
    // NOTIFICATIONS
    // ============================================
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.style.display = 'block';
      
      setTimeout(function() {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
