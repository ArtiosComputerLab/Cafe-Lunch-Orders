<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Lunch Order Form 2025-2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f8f9fa;
            color: #202124;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            font-weight: 400;
            margin-bottom: 10px;
        }
        
        .header .notice {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-top: 15px;
        }
        
        .sync-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34a853;
            animation: pulse 2s infinite;
        }
        
        .sync-indicator.offline {
            background: #fbbc04;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .store-status {
            text-align: center;
            padding: 15px;
            margin: 20px 30px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .store-status.store-open {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .store-status.store-closed {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            padding: 30px;
        }
        
        .form-section {
            background: white;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #3c4043;
        }
        
        .required {
            color: #d93025;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 1px #4285f4;
        }
        
        .menu-section {
            margin: 30px 0;
        }
        
        .menu-section h3 {
            margin-bottom: 20px;
            color: #3c4043;
            font-size: 1.2em;
        }
        
        .day-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .day-tab {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 100px;
            text-align: center;
        }
        
        .day-tab:hover:not(.disabled) {
            border-color: #4285f4;
            transform: translateY(-1px);
        }
        
        .day-tab.active {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }
        
        .day-tab.disabled {
            background: #f5f5f5;
            color: #9aa0a6;
            cursor: not-allowed;
            border-color: #e0e0e0;
            opacity: 0.7;
        }
        
        .day-tab.disabled:hover {
            border-color: #e0e0e0;
            transform: none;
        }
        
        .day-name {
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .day-date {
            font-size: 0.85em;
            margin-top: 2px;
            opacity: 0.9;
        }
        
        .menu-for-day {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .menu-for-day.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .menu-category {
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .category-title {
            background: #34a853;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .menu-items {
            border: 1px solid #e0e0e0;
            border-top: none;
        }
        
        .menu-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background: #f8f9fa;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .item-name {
            font-weight: 500;
            color: #3c4043;
        }
        
        .item-price {
            font-weight: 600;
            color: #34a853;
            font-size: 1.1em;
        }
        
        .item-description {
            color: #5f6368;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .day-selection {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .day-selection input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .day-selection label {
            cursor: pointer;
            font-size: 0.9em;
            color: #5f6368;
        }
        
        .sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .cart-summary {
            background: white;
            border: 2px solid #4285f4;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(66,133,244,0.15);
        }
        
        .cart-title {
            color: #4285f4;
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        
        .cart-items::-webkit-scrollbar {
            width: 6px;
        }
        
        .cart-items::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .cart-items::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .cart-item-name {
            flex: 1;
            margin-right: 10px;
        }
        
        .cart-item-price {
            font-weight: 600;
            color: #34a853;
        }
        
        .empty-cart {
            text-align: center;
            color: #9aa0a6;
            font-style: italic;
            padding: 20px;
        }
        
        .cart-total {
            border-top: 2px solid #4285f4;
            padding-top: 15px;
            text-align: center;
        }
        
        .total-label {
            font-size: 0.9em;
            color: #5f6368;
            margin-bottom: 5px;
        }
        
        .total-amount {
            font-size: 1.8em;
            font-weight: 600;
            color: #4285f4;
            margin-bottom: 15px;
        }
        
        .checkout-btn {
            width: 100%;
            background: #34a853;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkout-btn:hover:not(:disabled) {
            background: #2e7d32;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(52,168,83,0.3);
        }
        
        .checkout-btn:disabled {
            background: #dadce0;
            cursor: not-allowed;
            transform: none;
        }
        
        .history-btn {
            width: 100%;
            background: white;
            color: #4285f4;
            border: 1px solid #4285f4;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        
        .history-btn:hover {
            background: #f0f5ff;
        }
        
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        .payment-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .payment-header {
            color: #4285f4;
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .payment-amount {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .payment-steps {
            text-align: left;
            margin: 20px 0;
        }
        
        .payment-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .step-number {
            background: #4285f4;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        
        .venmo-btn {
            background: #3D95CE;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 10px;
            text-decoration: none;
            display: inline-block;
        }
        
        .venmo-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(61,149,206,0.3);
        }
        
        .confirmation-btn {
            background: #34a853;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.2s;
        }
        
        .confirmation-btn:hover {
            background: #2e7d32;
        }
        
        .cancel-btn {
            background: #dadce0;
            color: #3c4043;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.2s;
        }
        
        .cancel-btn:hover {
            background: #c5c8cc;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            font-size: 0.95em;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                order: -1;
            }
            
            .sync-status {
                position: static;
                margin: 10px auto;
                width: fit-content;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .day-tabs {
                overflow-x: scroll;
            }
            
            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="sync-status" id="sync-status">
                <div class="sync-indicator" id="sync-indicator"></div>
                <span id="sync-text">Cloud Sync Active</span>
            </div>
            <h1>üçΩÔ∏è Cafe Lunch Order Form 2025-2026</h1>
            <div class="notice">
                <strong>Order & Payment Cutoff: Daily at 8:00 AM</strong><br>
                ONE FORM PER PERSON ‚Ä¢ Preorder for the whole week or daily<br>
                Form closed daily from 8:00 AM - 1:00 PM<br>
                Contact: CRivers@artiosacademies.com
            </div>
        </div>
        
        <div class="store-status" id="store-status">
            Checking store hours...
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="first-name">Student First Name <span class="required">*</span></label>
                        <input type="text" id="first-name" required>
                    </div>
                    <div class="form-group">
                        <label for="last-name">Student Last Name <span class="required">*</span></label>
                        <input type="text" id="last-name" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email <span class="required">*</span></label>
                        <input type="email" id="email" required placeholder="parent@example.com">
                    </div>
                    <div class="form-group">
                        <label for="grade">Grade <span class="required">*</span></label>
                        <select id="grade" required>
                            <option value="">Select Grade</option>
                            <option value="K-2">K-2</option>
                            <option value="3-4">3-4</option>
                            <option value="5-6">5-6</option>
                            <option value="7-8">7-8</option>
                            <option value="9-12">9-12</option>
                            <option value="Staff">Staff</option>
                            <option value="Parent">Parent</option>
                        </select>
                    </div>
                </div>
                
                <div class="menu-section">
                    <h3>Select Days & Menu Items</h3>
                    
                    <div class="day-tabs" id="day-tabs">
                        <!-- Tabs will be generated by JavaScript -->
                    </div>
                    
                    <div id="menu-container">
                        <!-- Menu for each day will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="cart-summary">
                    <div class="cart-title">üìã Your Order</div>
                    <button type="button" class="history-btn" id="history-btn">
                        View Order History
                    </button>
                    <div class="cart-items" id="cart-items">
                        <div class="empty-cart">No items selected</div>
                    </div>
                    <div class="cart-total">
                        <div class="total-label">Order Total</div>
                        <div class="total-amount">$<span id="total-amount">0.00</span></div>
                        <button type="button" class="checkout-btn" id="checkout-btn" disabled>
                            Review & Pay Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div class="payment-modal" id="payment-modal">
        <div class="payment-content">
            <div class="payment-header">Complete Your Order</div>
            <div class="payment-amount">
                Total: $<span id="modal-total">0.00</span>
            </div>
            
            <div class="payment-steps">
                <div class="payment-step">
                    <div class="step-number">1</div>
                    <div>Click "Pay with Venmo" to open Venmo with order details</div>
                </div>
                <div class="payment-step">
                    <div class="step-number">2</div>
                    <div>Complete payment to <strong>@ChanTa-Rivers</strong></div>
                </div>
                <div class="payment-step">
                    <div class="step-number">3</div>
                    <div>Return here and click "I've Paid" to submit your order</div>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <a href="#" id="venmo-payment-link" class="venmo-btn">
                    üí≥ Pay with Venmo ($<span id="venmo-total">0.00</span>)
                </a>
            </div>
            
            <div style="border-top: 1px solid #e0e0e0; padding-top: 20px;">
                <button type="button" class="confirmation-btn" id="confirm-payment-btn">
                    ‚úÖ I've Paid - Submit Order
                </button>
                <button type="button" class="cancel-btn" id="cancel-payment-btn">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE THIS SECTION
        // ============================================
        const GOOGLE_SHEETS_CONFIG = {
            webAppUrl: '', // PASTE YOUR WEB APP URL HERE
            useGoogleSheets: false, // SET TO true AFTER ADDING URL
            fallbackToLocalStorage: true
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentTotal = 0;
        let orderItems = [];
        let currentDay = 'monday';
        let storeIsOpen = true;
        let cloudSyncActive = false;

        // Menu data structure
        const menuData = {
            entrees: [
                { id: 'chicken-sandwich', name: 'Chicken Sandwich', price: 6.50, desc: 'Classic boneless breast of chicken' },
                { id: 'spicy-chicken', name: 'Spicy Chicken Sandwich', price: 6.75, desc: 'Boneless breast with spicy seasoning' },
                { id: 'nuggets-8', name: 'Nuggets (8ct)', price: 6.50, desc: 'Bite-sized boneless chicken pieces' },
                { id: 'grilled-nuggets', name: 'Grilled Nuggets (8ct)', price: 7.50, desc: 'Grilled boneless chicken pieces' },
                { id: 'grilled-sandwich', name: 'Grilled Sandwich', price: 8.25, desc: 'Grilled chicken breast sandwich' },
                { id: 'grilled-gf', name: 'Grilled Sandwich (GF Bun)', price: 9.50, desc: 'Grilled chicken with gluten-free bun' },
                { id: 'chicken-wrap', name: 'Chicken Wrap', price: 9.75, desc: 'Chicken with fresh vegetables in a wrap' },
                { id: 'veggie-wrap', name: 'Southwest Veggie Wrap', price: 9.50, desc: 'Fresh vegetables with southwest flavors' },
                { id: 'chicken-strips', name: 'Chicken Strips (3ct)', price: 6.75, desc: 'Hand-breaded chicken strips' }
            ],
            addons: [
                { id: 'chips-drink', name: 'Chips & Drink', price: 1.50, desc: 'Add to any entree' },
                { id: 'fries-drink', name: 'Fries & Drink', price: 3.75, desc: 'Add to any entree' },
                { id: 'fruit-drink', name: 'Fruit Cup & Drink', price: 5.50, desc: 'Add to any entree' },
                { id: 'mac-drink', name: 'Mac & Cheese & Drink', price: 5.50, desc: 'Add to any entree' },
                { id: 'salad-drink', name: 'Side Salad & Drink', price: 5.50, desc: 'Add to any entree' },
                { id: 'cookie-drink', name: 'Cookie Parfait & Drink', price: 5.75, desc: 'Add to any entree' }
            ],
            sides: [
                { id: 'fries-only', name: 'Fries', price: 3.75 },
                { id: 'fruit-only', name: 'Fruit Cup', price: 5.50 },
                { id: 'mac-only', name: 'Mac & Cheese', price: 5.50 },
                { id: 'salad-only', name: 'Side Salad', price: 5.50 },
                { id: 'cookie-only', name: 'Cookie Parfait', price: 5.75 }
            ],
            salads: [
                { id: 'cobb-salad', name: 'Cobb Salad', price: 11.25, desc: 'Mixed greens with chicken, bacon, cheese' },
                { id: 'southwest-salad', name: 'Southwest Salad', price: 11.50, desc: 'Mixed greens with southwest flavors' },
                { id: 'market-salad', name: 'Market Fresh Salad', price: 11.50, desc: 'Seasonal fresh vegetables and greens' }
            ]
        };

        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
        const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            generateDayTabs();
            generateMenus();
            checkStoreHours();
            setupEventListeners();
            updateSyncStatus();
            
            // Check store hours every minute
            setInterval(checkStoreHours, 60000);
            
            // Check Google Sheets status if configured
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets && GOOGLE_SHEETS_CONFIG.webAppUrl) {
                checkStoreStatusFromSheets();
                setInterval(checkStoreStatusFromSheets, 300000); // Every 5 minutes
            }
        });

        function initializeDates() {
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            
            // Get Monday of current week
            const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
            monday.setDate(diff);
            
            return monday;
        }

        function generateDayTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            const monday = initializeDates();
            const today = new Date();
            const currentHour = today.getHours();
            
            let firstAvailableDay = null;
            
            days.forEach((day, index) => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + index);
                
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today || (isToday && currentHour >= 8);
                
                const tab = document.createElement('div');
                tab.className = 'day-tab';
                tab.dataset.day = day;
                
                if (isPast) {
                    tab.classList.add('disabled');
                } else if (!firstAvailableDay) {
                    firstAvailableDay = day;
                    tab.classList.add('active');
                    currentDay = day;
                }
                
                tab.innerHTML = `
                    <div class="day-name">${dayNames[index]}</div>
                    <div class="day-date">${date.getMonth() + 1}/${date.getDate()}</div>
                `;
                
                if (!isPast) {
                    tab.addEventListener('click', () => switchDay(day));
                }
                
                tabsContainer.appendChild(tab);
            });
            
            if (!firstAvailableDay) {
                document.getElementById('menu-container').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #5f6368;">
                        <h3>No days available for ordering this week</h3>
                        <p>Orders for next week will open on Monday at 1:00 PM</p>
                    </div>
                `;
            }
        }

        function generateMenus() {
            const container = document.getElementById('menu-container');
            
            days.forEach(day => {
                const dayDisplay = dayNames[days.indexOf(day)];
                const menuDiv = document.createElement('div');
                menuDiv.className = 'menu-for-day';
                menuDiv.dataset.day = day;
                if (day === currentDay) {
                    menuDiv.classList.add('active');
                }
                
                menuDiv.innerHTML = `
                    ${createCategoryHTML('Entrees', menuData.entrees, day, dayDisplay, false)}
                    ${createCategoryHTML('Add-Ons (Save $1.50!)', menuData.addons, day, dayDisplay, true)}
                    ${createCategoryHTML('Sides Only', menuData.sides, day, dayDisplay, false)}
                    ${createCategoryHTML('Salads', menuData.salads, day, dayDisplay, false)}
                `;
                
                container.appendChild(menuDiv);
            });
        }

        function createCategoryHTML(title, items, day, dayDisplay, isAddon) {
            const itemsHTML = items.map(item => {
                const uniqueId = `${item.id}-${day}`;
                const pricePrefix = isAddon ? '+$' : '$';
                const descHTML = item.desc ? `<div class="item-description">${item.desc}</div>` : '';
                
                return `
                    <div class="menu-item">
                        <div class="item-header">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">${pricePrefix}${item.price.toFixed(2)}</div>
                        </div>
                        ${descHTML}
                        <div class="day-selection">
                            <input type="checkbox" id="${uniqueId}" 
                                data-item="${item.name}" 
                                data-price="${item.price}" 
                                data-day="${dayDisplay}"
                                data-id="${uniqueId}">
                            <label for="${uniqueId}">Add to ${dayDisplay} order</label>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="menu-category">
                    <div class="category-title">${title}</div>
                    <div class="menu-items">
                        ${itemsHTML}
                    </div>
                </div>
            `;
        }

        function switchDay(day) {
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.day === day && !tab.classList.contains('disabled')) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.menu-for-day').forEach(menu => {
                menu.classList.remove('active');
                if (menu.dataset.day === day) {
                    menu.classList.add('active');
                }
            });
            
            currentDay = day;
        }

        // ============================================
        // STORE HOURS MANAGEMENT
        // ============================================
        function checkStoreHours() {
            const now = new Date();
            const hours = now.getHours();
            const statusElement = document.getElementById('store-status');
            
            if (hours >= 8 && hours < 13) {
                storeIsOpen = false;
                statusElement.className = 'store-status store-closed';
                statusElement.textContent = 'üîí Store is CLOSED (8:00 AM - 1:00 PM). Orders will open at 1:00 PM.';
                disableOrdering(true);
            } else {
                storeIsOpen = true;
                statusElement.className = 'store-status store-open';
                const nextCutoff = hours >= 13 ? 'tomorrow at 8:00 AM' : 'today at 8:00 AM';
                statusElement.textContent = `‚úÖ Store is OPEN! Next cutoff: ${nextCutoff}`;
                disableOrdering(false);
            }
        }

        function checkStoreStatusFromSheets() {
            if (!GOOGLE_SHEETS_CONFIG.webAppUrl) return;
            
            fetch(`${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=status`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.status) {
                    updateStoreStatus(data.status);
                    cloudSyncActive = true;
                    updateSyncStatus();
                }
            })
            .catch(error => {
                console.error('Error checking store status:', error);
                cloudSyncActive = false;
                updateSyncStatus();
            });
        }

        function updateStoreStatus(status) {
            const statusElement = document.getElementById('store-status');
            
            if (status.isOpen) {
                statusElement.className = 'store-status store-open';
                statusElement.textContent = `‚úÖ ${status.message}. Next cutoff: ${status.nextClose}`;
                disableOrdering(false);
            } else {
                statusElement.className = 'store-status store-closed';
                statusElement.textContent = `üîí ${status.message}. Opens at ${status.nextOpen}`;
                disableOrdering(true);
            }
        }

        function disableOrdering(disabled) {
            const inputs = document.querySelectorAll('input, select, button');
            inputs.forEach(input => {
                if (input.id !== 'history-btn') {
                    input.disabled = disabled;
                }
            });
            
            if (disabled) {
                const checkoutBtn = document.getElementById('checkout-btn');
                checkoutBtn.textContent = 'Store Closed';
            }
        }

        function updateSyncStatus() {
            const indicator = document.getElementById('sync-indicator');
            const text = document.getElementById('sync-text');
            
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets && GOOGLE_SHEETS_CONFIG.webAppUrl) {
                if (cloudSyncActive) {
                    indicator.classList.remove('offline');
                    text.textContent = 'Cloud Sync Active';
                } else {
                    indicator.classList.add('offline');
                    text.textContent = 'Local Storage Only';
                }
            } else {
                indicator.classList.add('offline');
                text.textContent = 'Local Storage Only';
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            ['first-name', 'last-name', 'email', 'grade'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validateForm);
                    if (id === 'email') {
                        element.addEventListener('blur', checkOrderHistory);
                    }
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.type === 'checkbox' && e.target.dataset.item) {
                    updateCart();
                }
            });
            
            document.getElementById('checkout-btn').addEventListener('click', openPaymentModal);
            document.getElementById('history-btn').addEventListener('click', showOrderHistory);
            document.getElementById('cancel-payment-btn').addEventListener('click', closePaymentModal);
            document.getElementById('confirm-payment-btn').addEventListener('click', submitOrder);
            
            document.getElementById('payment-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePaymentModal();
                }
            });
        }

        // ============================================
        // CART MANAGEMENT
        // ============================================
        function updateCart() {
            orderItems = [];
            currentTotal = 0;
            
            const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const itemsByDay = {};
            
            checkedBoxes.forEach(checkbox => {
                const item = checkbox.dataset.item;
                const price = parseFloat(checkbox.dataset.price);
                const day = checkbox.dataset.day;
                const id = checkbox.dataset.id;
                
                if (!itemsByDay[day]) {
                    itemsByDay[day] = [];
                }
                
                itemsByDay[day].push({
                    id: id,
                    name: item,
                    price: price,
                    day: day
                });
                
                currentTotal += price;
            });
            
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            dayOrder.forEach(day => {
                if (itemsByDay[day]) {
                    orderItems.push(...itemsByDay[day]);
                }
            });
            
            displayCart();
            validateForm();
        }

        function displayCart() {
            const cartItemsDiv = document.getElementById('cart-items');
            const totalSpan = document.getElementById('total-amount');
            
            if (orderItems.length === 0) {
                cartItemsDiv.innerHTML = '<div class="empty-cart">No items selected</div>';
            } else {
                let currentDay = '';
                let html = '';
                
                orderItems.forEach(item => {
                    if (item.day !== currentDay) {
                        if (currentDay !== '') {
                            html += '<div style="margin: 10px 0; border-bottom: 1px solid #e0e0e0;"></div>';
                        }
                        html += `<div style="font-weight: 600; color: #4285f4; margin-bottom: 5px; font-size: 0.85em;">${item.day}</div>`;
                        currentDay = item.day;
                    }
                    
                    html += `
                        <div class="cart-item">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                cartItemsDiv.innerHTML = html;
            }
            
            totalSpan.textContent = currentTotal.toFixed(2);
        }

        function validateForm() {
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const email = document.getElementById('email').value.trim();
            const grade = document.getElementById('grade').value;
            const checkoutBtn = document.getElementById('checkout-btn');
            
            const formValid = firstName && lastName && email && grade && orderItems.length > 0;
            
            if (!storeIsOpen) {
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Store Closed';
            } else if (formValid) {
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = `Review & Pay Order ($${currentTotal.toFixed(2)})`;
            } else {
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Review & Pay Order';
            }
        }

        // ============================================
        // ORDER HISTORY MANAGEMENT
        // ============================================
        function checkOrderHistory() {
            const email = document.getElementById('email').value.trim();
            if (!email) return;
            
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets && GOOGLE_SHEETS_CONFIG.webAppUrl) {
                fetch(`${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=history&email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.orders && data.orders.length > 0) {
                        checkOrderHistoryNotification(data.orders, email);
                    }
                })
                .catch(error => {
                    console.error('Error fetching history:', error);
                    checkLocalOrderHistory();
                });
            } else {
                checkLocalOrderHistory();
            }
        }

        function checkLocalOrderHistory() {
            const email = document.getElementById('email').value.trim();
            if (!email) return;
            
            try {
                const orders = JSON.parse(localStorage.getItem('cafeOrders') || '[]');
                const userOrders = orders.filter(order => 
                    order.email.toLowerCase() === email.toLowerCase()
                );
                
                if (userOrders.length > 0) {
                    checkOrderHistoryNotification(userOrders, email);
                }
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        function showDetailedOrderConfirmation(order) {
            const itemsByDay = {};
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            order.items.forEach(item => {
                if (!itemsByDay[item.day]) {
                    itemsByDay[item.day] = [];
                }
                itemsByDay[item.day].push(item);
            });
            
            const sortedDays = Object.keys(itemsByDay).sort((a, b) => 
                dayOrder.indexOf(a) - dayOrder.indexOf(b)
            );
            
            let message = `‚úÖ ORDER CONFIRMED!\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            message += `üìã Order Details:\n`;
            message += `Order ID: ${order.orderId}\n`;
            message += `Date: ${new Date(order.timestamp).toLocaleString()}\n\n`;
            
            message += `üë§ Student Information:\n`;
            message += `Name: ${order.firstName} ${order.lastName}\n`;
            message += `Grade: ${order.grade}\n`;
            message += `Email: ${order.email}\n\n`;
            
            message += `üçΩÔ∏è Items Ordered:\n`;
            message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            
            let itemCount = 0;
            sortedDays.forEach(day => {
                message += `\n${day}:\n`;
                itemsByDay[day].forEach(item => {
                    itemCount++;
                    message += `  ‚Ä¢ ${item.name} - ${item.price.toFixed(2)}\n`;
                });
            });
            
            message += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            message += `Total Items: ${itemCount}\n`;
            message += `Total Amount: ${order.total.toFixed(2)}\n\n`;
            
            message += `üí≥ Payment:\n`;
            message += `Method: Venmo (@ChanTa-Rivers)\n`;
            message += `Status: Confirmed\n\n`;
            
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets) {
                message += `‚òÅÔ∏è Order synced to cloud\n`;
            }
            message += `üìß Confirmation email will be sent to:\n${order.email}\n\n`;
            message += `Questions? Contact:\nCRivers@artiosacademies.com`;
            
            alert(message);
        }

        function resetForm() {
            document.getElementById('first-name').value = '';
            document.getElementById('last-name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('grade').value = '';
            
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
            });
            
            orderItems = [];
            currentTotal = 0;
            displayCart();
            validateForm();
        }

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        function showNotification(message, type = 'info') {
            const existingNotif = document.querySelector('.notification');
            if (existingNotif) {
                existingNotif.remove();
            }
            
            let bgColor, textColor, borderColor, icon;
            switch(type) {
                case 'warning':
                    bgColor = '#fff3cd';
                    textColor = '#856404';
                    borderColor = '#ffeeba';
                    icon = '‚ö†Ô∏è';
                    break;
                case 'success':
                    bgColor = '#d4edda';
                    textColor = '#155724';
                    borderColor = '#c3e6cb';
                    icon = '‚úÖ';
                    break;
                case 'error':
                    bgColor = '#f8d7da';
                    textColor = '#721c24';
                    borderColor = '#f5c6cb';
                    icon = '‚ùå';
                    break;
                default:
                    bgColor = '#e3f2fd';
                    textColor = '#1976d2';
                    borderColor = '#bbdefb';
                    icon = '‚ÑπÔ∏è';
            }
            
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.style.background = bgColor;
            notif.style.color = textColor;
            notif.style.border = `1px solid ${borderColor}`;
            
            notif.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">${icon}</span>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; cursor: pointer; font-size: 1.2em; margin-left: auto; padding: 0 5px;">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notif);
            
            const duration = type === 'success' ? 3000 : 5000;
            setTimeout(() => {
                if (notif.parentElement) {
                    notif.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => notif.remove(), 300);
                }
            }, duration);
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
    </script>
</body>
</html>
                console.error('Error checking order history:', e);
            }
        }

        function checkOrderHistoryNotification(orders, email) {
            const monday = getMonday(new Date());
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const thisWeekOrders = orders.filter(order => {
                const orderDate = new Date(order.timestamp);
                return orderDate >= monday && orderDate <= sunday;
            });
            
            if (thisWeekOrders.length > 0) {
                const students = [...new Set(thisWeekOrders.map(o => 
                    `${o.firstName} ${o.lastName}`
                ))];
                
                const message = `Found ${thisWeekOrders.length} order(s) this week for: ${students.join(', ')}`;
                showNotification(message, 'info');
                
                const historyBtn = document.getElementById('history-btn');
                historyBtn.style.background = '#e3f2fd';
                historyBtn.style.color = '#1976d2';
                historyBtn.innerHTML = `üìã View Orders <span style="background: #1976d2; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 5px;">${thisWeekOrders.length}</span>`;
                
                setTimeout(() => {
                    historyBtn.style.background = '';
                    historyBtn.style.color = '';
                    historyBtn.innerHTML = 'View Order History';
                }, 10000);
            }
        }

        function showOrderHistory() {
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                alert('Please enter your email address to view order history.');
                document.getElementById('email').focus();
                return;
            }
            
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets && GOOGLE_SHEETS_CONFIG.webAppUrl) {
                showNotification('Loading order history...', 'info');
                
                fetch(`${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=history&email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.orders) {
                        const localOrders = JSON.parse(localStorage.getItem('cafeOrders') || '[]')
                            .filter(order => order.email.toLowerCase() === email.toLowerCase());
                        const allOrders = mergeOrders(data.orders, localOrders);
                        displayOrderHistory(allOrders, email);
                    } else {
                        showLocalOrderHistory();
                    }
                })
                .catch(error => {
                    console.error('Error fetching from Google Sheets:', error);
                    showNotification('Using local history (cloud sync unavailable)', 'warning');
                    showLocalOrderHistory();
                });
            } else {
                showLocalOrderHistory();
            }
        }

        function showLocalOrderHistory() {
            const email = document.getElementById('email').value.trim();
            
            try {
                const orders = JSON.parse(localStorage.getItem('cafeOrders') || '[]');
                const userOrders = orders.filter(order => 
                    order.email.toLowerCase() === email.toLowerCase()
                );
                
                displayOrderHistory(userOrders, email);
            } catch (e) {
                console.error('Error loading order history:', e);
                alert('Unable to load order history.');
            }
        }

        function mergeOrders(sheetsOrders, localOrders) {
            const orderMap = new Map();
            
            sheetsOrders.forEach(order => {
                order.fromSheets = true;
                orderMap.set(order.orderId, order);
            });
            
            localOrders.forEach(order => {
                if (!orderMap.has(order.orderId)) {
                    order.fromSheets = false;
                    orderMap.set(order.orderId, order);
                }
            });
            
            return Array.from(orderMap.values());
        }

        function displayOrderHistory(orders, email) {
            if (orders.length === 0) {
                alert(`No order history found for: ${email}\n\nIf you've placed orders, they may be on a different device or browser.`);
                return;
            }
            
            orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const ordersByStudent = {};
            orders.forEach(order => {
                const studentKey = `${order.firstName} ${order.lastName}`;
                if (!ordersByStudent[studentKey]) {
                    ordersByStudent[studentKey] = {
                        grade: order.grade,
                        orders: []
                    };
                }
                ordersByStudent[studentKey].orders.push(order);
            });
            
            const monday = getMonday(new Date());
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            let message = `üìã ORDER HISTORY${GOOGLE_SHEETS_CONFIG.useGoogleSheets ? ' (Cloud + Local)' : ' (Local Only)'}\n`;
            message += `Email: ${email}\n`;
            message += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            
            Object.keys(ordersByStudent).sort().forEach(student => {
                const studentData = ordersByStudent[student];
                const totalSpent = studentData.orders.reduce((sum, order) => sum + order.total, 0);
                
                message += `\nüë§ ${student}\n`;
                message += `   Grade: ${studentData.grade}\n`;
                message += `   Total Orders: ${studentData.orders.length}\n`;
                message += `   Total Spent: $${totalSpent.toFixed(2)}\n`;
                message += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                const recentOrders = studentData.orders.slice(0, 5);
                
                recentOrders.forEach(order => {
                    const orderDate = new Date(order.timestamp);
                    const isThisWeek = orderDate >= monday && orderDate <= sunday;
                    const dateStr = orderDate.toLocaleDateString();
                    const timeStr = orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const source = order.fromSheets ? '‚òÅÔ∏è' : 'üíæ';
                    
                    message += `\n   ${GOOGLE_SHEETS_CONFIG.useGoogleSheets ? source : ''} ${isThisWeek ? 'üîµ' : '‚óã'} ${dateStr} at ${timeStr}\n`;
                    message += `      Order: ${order.orderId}\n`;
                    message += `      Total: $${order.total.toFixed(2)}\n`;
                    
                    const itemsByDay = {};
                    const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                    
                    order.items.forEach(item => {
                        if (!itemsByDay[item.day]) {
                            itemsByDay[item.day] = [];
                        }
                        itemsByDay[item.day].push(item.name);
                    });
                    
                    const sortedDays = Object.keys(itemsByDay).sort((a, b) => 
                        dayOrder.indexOf(a) - dayOrder.indexOf(b)
                    );
                    
                    sortedDays.forEach(day => {
                        const dayItems = itemsByDay[day].join(', ');
                        message += `      ${day}: ${dayItems}\n`;
                    });
                });
                
                if (studentData.orders.length > 5) {
                    message += `\n   ... and ${studentData.orders.length - 5} more orders\n`;
                }
            });
            
            message += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            message += `üìä SUMMARY\n`;
            message += `Total Students: ${Object.keys(ordersByStudent).length}\n`;
            message += `Total Orders: ${orders.length}\n`;
            
            const thisWeekOrders = orders.filter(order => {
                const orderDate = new Date(order.timestamp);
                return orderDate >= monday && orderDate <= sunday;
            });
            
            if (thisWeekOrders.length > 0) {
                const weekTotal = thisWeekOrders.reduce((sum, order) => sum + order.total, 0);
                message += `\nThis Week: ${thisWeekOrders.length} orders ($${weekTotal.toFixed(2)})\n`;
            }
            
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets) {
                message += `\n‚òÅÔ∏è = Cloud synced | üíæ = Local only\n`;
            }
            message += `üîµ = Current week order\n`;
            message += `\nQuestions? Contact:\nCRivers@artiosacademies.com`;
            
            alert(message);
            
            // Offer to sync local orders if using Google Sheets
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets) {
                const localOnlyOrders = orders.filter(o => !o.fromSheets);
                if (localOnlyOrders.length > 0) {
                    setTimeout(() => {
                        if (confirm(`Found ${localOnlyOrders.length} local-only orders. Would you like to sync them to the cloud?`)) {
                            syncLocalOrdersToSheets(localOnlyOrders);
                        }
                    }, 500);
                }
            }
        }

        function syncLocalOrdersToSheets(orders) {
            showNotification(`Syncing ${orders.length} orders to cloud...`, 'info');
            
            let syncCount = 0;
            let errorCount = 0;
            
            orders.forEach(order => {
                fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({...order, sendConfirmation: false})
                })
                .then(() => {
                    syncCount++;
                    if (syncCount + errorCount === orders.length) {
                        showNotification(`Sync complete: ${syncCount} succeeded, ${errorCount} failed`, 
                            errorCount > 0 ? 'warning' : 'success');
                    }
                })
                .catch(error => {
                    errorCount++;
                    console.error('Error syncing order:', error);
                    if (syncCount + errorCount === orders.length) {
                        showNotification(`Sync complete: ${syncCount} succeeded, ${errorCount} failed`, 
                            errorCount > 0 ? 'warning' : 'success');
                    }
                });
            });
        }

        // ============================================
        // PAYMENT & ORDER SUBMISSION
        // ============================================
        function openPaymentModal() {
            if (!checkDuplicateOrder()) {
                return;
            }
            
            const modal = document.getElementById('payment-modal');
            const modalTotal = document.getElementById('modal-total');
            const venmoTotal = document.getElementById('venmo-total');
            const venmoLink = document.getElementById('venmo-payment-link');
            
            modalTotal.textContent = currentTotal.toFixed(2);
            venmoTotal.textContent = currentTotal.toFixed(2);
            
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            
            const itemsByDay = {};
            orderItems.forEach(item => {
                if (!itemsByDay[item.day]) {
                    itemsByDay[item.day] = [];
                }
                itemsByDay[item.day].push(item.name);
            });
            
            let orderNote = `Lunch: ${firstName} ${lastName}\n`;
            Object.keys(itemsByDay).forEach(day => {
                orderNote += `${day}: ${itemsByDay[day].join(', ')}\n`;
            });
            
            const venmoUrl = `venmo://paycharge?txn=pay&recipients=ChanTa-Rivers&amount=${currentTotal.toFixed(2)}&note=${encodeURIComponent(orderNote)}`;
            venmoLink.href = venmoUrl;
            
            venmoLink.onclick = function(e) {
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (!isMobile) {
                    e.preventDefault();
                    window.open('https://venmo.com/u/ChanTa-Rivers', '_blank');
                    
                    const paymentDetails = `Pay: @ChanTa-Rivers\nAmount: $${currentTotal.toFixed(2)}\nNote: ${orderNote}`;
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(paymentDetails).then(() => {
                            alert('Payment details copied to clipboard!\n\n' + paymentDetails);
                        }).catch(() => {
                            alert('Please send payment to:\n\n' + paymentDetails);
                        });
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.value = paymentDetails;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert('Payment details copied to clipboard!\n\n' + paymentDetails);
                        } catch (err) {
                            alert('Please send payment to:\n\n' + paymentDetails);
                        }
                        document.body.removeChild(textArea);
                    }
                }
            };
            
            modal.style.display = 'flex';
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
        }

        function checkDuplicateOrder() {
            const email = document.getElementById('email').value.trim();
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            
            try {
                const orders = JSON.parse(localStorage.getItem('cafeOrders') || '[]');
                
                const monday = getMonday(new Date());
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                
                const studentOrders = orders.filter(order => {
                    const orderDate = new Date(order.timestamp);
                    return orderDate >= monday && orderDate <= sunday &&
                           order.email.toLowerCase() === email.toLowerCase() &&
                           order.firstName.toLowerCase() === firstName.toLowerCase() &&
                           order.lastName.toLowerCase() === lastName.toLowerCase();
                });
                
                if (studentOrders.length > 0) {
                    const orderedDays = new Set();
                    studentOrders.forEach(order => {
                        order.items.forEach(item => {
                            orderedDays.add(item.day);
                        });
                    });
                    
                    const currentDays = [...new Set(orderItems.map(item => item.day))];
                    const conflicts = currentDays.filter(day => orderedDays.has(day));
                    
                    if (conflicts.length > 0) {
                        const conflictDays = conflicts.join(', ');
                        const message = `‚ö†Ô∏è Duplicate Order Warning\n\n` +
                                      `${firstName} ${lastName} already has lunch ordered for:\n` +
                                      `${conflictDays}\n\n` +
                                      `Do you want to place another order for these days?\n\n` +
                                      `Note: This will create a duplicate order that you'll need to pay for.`;
                        
                        return confirm(message);
                    }
                }
                
                const otherChildrenOrders = orders.filter(order => {
                    const orderDate = new Date(order.timestamp);
                    return orderDate >= monday && orderDate <= sunday &&
                           order.email.toLowerCase() === email.toLowerCase() &&
                           !(order.firstName.toLowerCase() === firstName.toLowerCase() &&
                             order.lastName.toLowerCase() === lastName.toLowerCase());
                });
                
                if (otherChildrenOrders.length > 0) {
                    const otherChildren = [...new Set(otherChildrenOrders.map(o => 
                        `${o.firstName} ${o.lastName}`
                    ))];
                    
                    showNotification(`‚ÑπÔ∏è Other children with orders this week: ${otherChildren.join(', ')}`, 'info');
                }
                
            } catch (e) {
                console.error('Error checking duplicates:', e);
            }
            
            return true;
        }

        function submitOrder() {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substr(2, 5).toUpperCase();
            const orderId = `LO${timestamp}${randomStr}`;
            
            const orderData = {
                orderId: orderId,
                timestamp: new Date().toISOString(),
                email: document.getElementById('email').value.trim(),
                firstName: document.getElementById('first-name').value.trim(),
                lastName: document.getElementById('last-name').value.trim(),
                grade: document.getElementById('grade').value,
                items: orderItems,
                total: currentTotal,
                paymentMethod: 'Venmo',
                paymentStatus: 'confirmed',
                sendConfirmation: true
            };
            
            showNotification('Submitting order...', 'info');
            
            if (GOOGLE_SHEETS_CONFIG.useGoogleSheets && GOOGLE_SHEETS_CONFIG.webAppUrl) {
                fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                })
                .then(() => {
                    if (GOOGLE_SHEETS_CONFIG.fallbackToLocalStorage) {
                        saveToLocalStorage(orderData);
                    }
                    
                    closePaymentModal();
                    showDetailedOrderConfirmation(orderData);
                    showNotification(`Order ${orderId} submitted successfully!`, 'success');
                    resetForm();
                })
                .catch(error => {
                    console.error('Error submitting to Google Sheets:', error);
                    
                    if (GOOGLE_SHEETS_CONFIG.fallbackToLocalStorage) {
                        saveToLocalStorage(orderData);
                        closePaymentModal();
                        showDetailedOrderConfirmation(orderData);
                        showNotification('Order saved locally (cloud sync failed)', 'warning');
                        resetForm();
                    } else {
                        showNotification('Error submitting order. Please try again.', 'error');
                    }
                });
            } else {
                saveToLocalStorage(orderData);
                closePaymentModal();
                showDetailedOrderConfirmation(orderData);
                showNotification(`Order ${orderId} saved successfully!`, 'success');
                resetForm();
            }
        }

        function saveToLocalStorage(orderData) {
            try {
                const orders = JSON.parse(localStorage.getItem('cafeOrders') || '[]');
                orders.push(orderData);
                localStorage.setItem('cafeOrders', JSON.stringify(orders));
                console.log('Order saved to localStorage:', orderData.orderId);
            } catch (e) {
