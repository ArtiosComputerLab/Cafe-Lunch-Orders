// ============================================
// ENHANCED CONFIGURATION WITH STAFF DISCOUNT SUPPORT
// ============================================
const SHEET_ID = '1vBlYUsY7lt0k4x7I_OxvjYbHvQn0hbR6HwHh_aCsHxA'; // Your actual Google Sheet ID
const ORDERS_SHEET = 'Orders';
const NOTIFICATION_EMAIL = 'jedaws@gmail.com'; // Report notification email

// ============================================
// MAIN FUNCTIONS - ENHANCED FOR STAFF DISCOUNT
// ============================================
/**
 * Handle POST requests (new orders) - UPDATED FOR STAFF DISCOUNT
 */
function doPost(e) {
  try {
    console.log('doPost called, raw event:', JSON.stringify(e));
    
    let data;
    
    // Handle different data formats
    if (e && e.postData && e.postData.contents) {
      console.log('Found postData.contents:', e.postData.contents);
      try {
        // Try direct JSON first
        data = JSON.parse(e.postData.contents);
        console.log('Successfully parsed as direct JSON');
      } catch (jsonError) {
        console.log('Direct JSON failed, trying form-encoded data');
        // Try form-encoded data
        const contents = e.postData.contents;
        if (contents.includes('data=')) {
          const encodedData = contents.split('data=')[1];
          data = JSON.parse(decodeURIComponent(encodedData));
          console.log('Successfully parsed as form-encoded data');
        } else {
          throw new Error('Could not parse postData contents');
        }
      }
    } else if (e && e.parameter && e.parameter.data) {
      console.log('Found parameter.data:', e.parameter.data);
      data = JSON.parse(e.parameter.data);
      console.log('Successfully parsed as parameter data');
    } else {
      console.error('No valid data found in request');
      return ContentService
        .createTextOutput(JSON.stringify({
          success: false,
          error: 'No data received in request',
          receivedData: {
            hasEvent: !!e,
            hasPostData: !!(e && e.postData),
            hasContents: !!(e && e.postData && e.postData.contents),
            hasParameter: !!(e && e.parameter),
            eventKeys: e ? Object.keys(e) : null
          }
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    console.log('Successfully parsed order data:', JSON.stringify(data));
    
    // Validate required fields
    if (!data.orderId || !data.email || !data.items || !data.children) {
      throw new Error('Missing required fields: orderId, email, items, or children');
    }
    
    // Save order to sheet (handles multi-child structure with staff discount)
    const result = saveMultiChildOrderToSheet(data);
    console.log('Order saved to sheet successfully');
    
    // Send confirmation email if requested
    if (data.sendConfirmation) {
      try {
        sendMultiChildConfirmationEmail(data);
        console.log('Confirmation email sent successfully');
      } catch (emailError) {
        console.error('Email failed but continuing:', emailError);
      }
    }
    
    const response = {
      success: true,
      orderId: data.orderId,
      message: 'Multi-child order saved successfully',
      childrenCount: data.children ? data.children.length : 0,
      itemsCount: data.items ? data.items.length : 0,
      staffDiscount: data.promoCode === 'STAFF2025' ? '10%' : 'None'
    };
    
    console.log('Returning success response:', JSON.stringify(response));
    
    return ContentService
      .createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error in doPost:', error.toString());
    console.error('Error stack:', error.stack);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString(),
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Handle GET requests - EMAIL-ONLY REPORTS
 */
function doGet(e) {
  try {
    const action = e.parameter.action;
    console.log('doGet called with action:', action);
    
    // Handle test requests
    if (action === 'test' || e.parameter.test === 'true') {
      return ContentService
        .createTextOutput(JSON.stringify({
          success: true,
          message: 'Google Apps Script is working correctly!',
          timestamp: new Date().toISOString(),
          sheetId: SHEET_ID,
          features: ['orders', 'email_reports', 'staff_discount']
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Generate EMAIL-ONLY report (no sheets created)
    if (action === 'generate_report') {
      const secret = e.parameter.secret;
      if (secret !== 'cafe2025') {
        return ContentService
          .createTextOutput(JSON.stringify({
            success: false,
            error: 'Invalid secret key'
          }))
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      try {
        const dateParam = e.parameter.date;
        let reportDate;
        
        if (dateParam) {
          reportDate = new Date(dateParam + 'T12:00:00');
          if (isNaN(reportDate.getTime())) {
            throw new Error('Invalid date format. Use YYYY-MM-DD');
          }
        } else {
          reportDate = new Date();
        }
        
        const result = generateEmailOnlyReport(reportDate);
        
        // Get recipients from URL parameters - split between admin and worker
        const adminRecipientsParam = e.parameter.admin_recipients || NOTIFICATION_EMAIL;
        const workerRecipientsParam = e.parameter.worker_recipients || '';
        
        const adminRecipients = adminRecipientsParam.split(',').map(email => email.trim()).filter(email => email);
        const workerRecipients = workerRecipientsParam.split(',').map(email => email.trim()).filter(email => email);
        
        console.log('Sending detailed report to admin recipients:', adminRecipients);
        console.log('Sending simple report to worker recipients:', workerRecipients);
        
        // Send detailed reports to admin recipients
        adminRecipients.forEach(email => {
          sendEnhancedReportNotificationEmail(result, reportDate, true, email);
        });
        
        // Send simple cafe worker reports
        workerRecipients.forEach(email => {
          sendSimpleCafeWorkerEmail(result, reportDate, email);
        });
        
        return ContentService
          .createTextOutput(JSON.stringify({
            success: true,
            message: 'Email report sent successfully',
            ordersProcessed: result.orderCount,
            reportDate: reportDate.toISOString().split('T')[0],
            emailSent: true,
            adminEmailsSent: adminRecipients.length,
            workerEmailsSent: workerRecipients.length,
            // NO SHEET URL - Email only
            note: 'Report sent via email only'
          }))
          .setMimeType(ContentService.MimeType.JSON);
        
      } catch (reportError) {
        console.error('Report generation error:', reportError);
        return ContentService
          .createTextOutput(JSON.stringify({
            success: false,
            error: `Report generation failed: ${reportError.toString()}`
          }))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: 'Unknown action: ' + action
      }))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error in doGet:', error);
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ============================================
// MULTI-CHILD ORDER MANAGEMENT - UPDATED FOR STAFF DISCOUNT
// ============================================
/**
 * Save multi-child order data to Google Sheet - UPDATED FOR STAFF DISCOUNT
 */
function saveMultiChildOrderToSheet(orderData) {
  try {
    console.log('Saving multi-child order to sheet:', orderData.orderId);
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(ORDERS_SHEET);
    
    orderData.items.forEach((item, index) => {
      console.log(`Processing item ${index + 1}:`, item.name, 'for child', item.childId);
      
      const child = orderData.children.find(c => c.id === item.childId) || orderData.children[0];
      
      if (!child) {
        console.error('Could not find child for item:', item);
        return;
      }
      
      const itemDate = getDateFromDayName(item.day, orderData.weekStart || orderData.timestamp);
      console.log('Item date calculated:', itemDate.toISOString().split('T')[0]);
      
      const rowData = [
        new Date(orderData.timestamp),        // A: Timestamp
        orderData.email,                      // B: Family email
        child.firstName,                      // C: Child first name
        child.lastName,                       // D: Child last name  
        "'" + child.grade,                    // E: Child grade (force as text)
        JSON.stringify([{                     // F: Item as single-element array
          name: item.name,
          day: item.day,
          price: item.price,
          childName: child.firstName + ' ' + child.lastName,
          grade: child.grade
        }]),
        item.price,                           // G: Item price (after drink discounts)
        orderData.orderId,                    // H: Order ID
        orderData.paymentMethod || 'Venmo',   // I: Payment method
        orderData.paymentStatus || 'confirmed', // J: Payment status
        item.childId || child.id,             // K: Child ID
        itemDate.toISOString().split('T')[0], // L: Actual DATE
        orderData.children ? orderData.children.length : 1, // M: Total children
        orderData.subtotal || orderData.total, // N: Subtotal (before staff discount)
        orderData.discount || 0,              // O: Staff discount amount
        orderData.total,                      // P: Final total (after staff discount)
        orderData.promoCode || ''             // Q: Promo code used
      ];
      
      console.log('Adding row to sheet:', rowData);
      sheet.appendRow(rowData);
    });
    
    console.log(`Multi-child order saved: ${orderData.orderId} with ${orderData.items.length} items, Staff Discount: ${orderData.promoCode === 'STAFF2025' ? 'Yes' : 'No'}`);
    return true;
    
  } catch (error) {
    console.error('Error saving multi-child order:', error);
    throw error;
  }
}

// ============================================
// EMAIL-ONLY REPORT GENERATION - NEW APPROACH
// ============================================
/**
 * Generate email-only report (no Google Sheets created)
 */
function generateEmailOnlyReport(reportDate) {
  try {
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const reportDayName = dayNames[reportDate.getDay()];
    
    console.log(`Generating email-only report for ${reportDate.toDateString()}`);
    
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(ORDERS_SHEET);
    const data = sheet.getDataRange().getValues();
    
    console.log(`Found ${data.length - 1} total rows in sheet`);
    
    const allOrders = [];
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      try {
        const item = JSON.parse(row[5])[0];
        
        let itemDateStr = '';
        if (row[11] instanceof Date) {
          itemDateStr = row[11].toISOString().split('T')[0];
        } else if (typeof row[11] === 'string') {
          itemDateStr = row[11].split('T')[0];
        } else {
          console.log(`Row ${i}: Unexpected itemDate format:`, row[11], typeof row[11]);
          continue;
        }
        
        const order = {
          timestamp: row[0],
          email: row[1],
          firstName: row[2],
          lastName: row[3],
          grade: row[4],
          item: item,
          itemPrice: parseFloat(row[6]) || 0,
          orderId: row[7],
          childId: row[10] || '1',
          itemDate: itemDateStr,
          subtotal: parseFloat(row[13]) || parseFloat(row[6]) || 0,
          discount: parseFloat(row[14]) || 0,
          total: parseFloat(row[15]) || parseFloat(row[6]) || 0,
          promoCode: row[16] || ''
        };
        allOrders.push(order);
        
      } catch (parseError) {
        console.error(`Error parsing row ${i}:`, parseError);
      }
    }
    
    console.log(`Successfully parsed ${allOrders.length} orders from sheet`);
    
    // Filter orders for this specific date
    const itemsForThisDate = [];
    const reportDateStr = reportDate.toISOString().split('T')[0];
    
    console.log(`Looking for items with date: ${reportDateStr}`);
    
    allOrders.forEach(order => {
      if (order.itemDate === reportDateStr) {
        itemsForThisDate.push({
          orderId: order.orderId,
          studentName: `${order.firstName} ${order.lastName}`,
          grade: order.grade,
          email: order.email,
          item: order.item,
          itemPrice: order.itemPrice,
          orderTime: order.timestamp,
          intendedDate: order.itemDate,
          childId: order.childId,
          subtotal: order.subtotal,
          discount: order.discount,
          total: order.total,
          promoCode: order.promoCode
        });
        console.log(`‚úÖ MATCH FOUND: ${order.orderId} - ${order.item.name} (Staff Discount: ${order.promoCode === 'STAFF2025' ? 'Yes' : 'No'})`);
      }
    });
    
    console.log(`Found ${itemsForThisDate.length} items for ${reportDayName} ${reportDate.toDateString()}`);
    
    if (itemsForThisDate.length === 0) {
      return {
        orderCount: 0,
        foodItemCount: 0,
        drinkItemCount: 0,
        reportData: {
          itemsForThisDate: [],
          itemCounts: {},
          totalRevenue: 0,
          totalDiscounts: 0,
          familiesServed: 0,
          customerData: [],
          orderingData: []
        }
      };
    }
    
    // Process the data for email reports
    const itemCounts = {};
    let totalRevenue = 0;
    let totalDiscounts = 0;
    
    itemsForThisDate.forEach(orderItem => {
      const itemName = orderItem.item.name;
      const price = orderItem.itemPrice;
      
      if (!itemCounts[itemName]) {
        itemCounts[itemName] = { count: 0, price: price, total: 0 };
      }
      itemCounts[itemName].count++;
      itemCounts[itemName].total += price;
      totalRevenue += orderItem.total; // Final total after staff discount
      totalDiscounts += orderItem.discount; // Staff discount amount
    });
    
    const customerData = itemsForThisDate.map(item => [
      item.orderId,
      item.studentName,
      item.grade,
      item.email,
      item.item.name,
      `$${item.itemPrice.toFixed(2)}`,
      new Date(item.orderTime).toLocaleString(),
      item.childId,
      item.promoCode ? 'STAFF2025' : 'None'
    ]);
    
    const orderingData = Object.keys(itemCounts).map(itemName => [
      itemName,
      itemCounts[itemName].count,
      `$${itemCounts[itemName].price.toFixed(2)}`,
      `$${itemCounts[itemName].total.toFixed(2)}`
    ]);
    
    return {
      orderCount: itemsForThisDate.length,
      foodItemCount: Object.values(itemCounts).reduce((sum, item) => sum + item.count, 0),
      reportData: {
        itemsForThisDate: itemsForThisDate,
        itemCounts: itemCounts,
        totalRevenue: totalRevenue,
        totalDiscounts: totalDiscounts,
        familiesServed: new Set(itemsForThisDate.map(item => item.email)).size,
        customerData: customerData,
        orderingData: orderingData
      }
    };
    
  } catch (error) {
    console.error('Error generating email-only report:', error);
    console.error('Error stack:', error.stack);
    throw error;
  }
}

// ============================================
// EMAIL FUNCTIONS - UPDATED FOR STAFF DISCOUNT
// ============================================
/**
 * Send confirmation email for multi-child orders - UPDATED FOR STAFF DISCOUNT
 */
function sendMultiChildConfirmationEmail(orderData) {
  try {
    const subject = `Artios Academies Cafe Order Confirmed - Order #${orderData.orderId}`;
    
    const itemsByChild = {};
    orderData.items.forEach(item => {
      const child = orderData.children.find(c => c.id === item.childId);
      const childKey = child ? `${child.firstName} ${child.lastName}` : 'Unknown Child';
      
      if (!itemsByChild[childKey]) {
        itemsByChild[childKey] = {
          grade: child ? child.grade : 'Unknown',
          items: []
        };
      }
      
      itemsByChild[childKey].items.push(item);
    });
    
    let emailBody = `
      <h2>Artios Academies Family Cafe Order Confirmed!</h2>
      
      <p><strong>Order Details:</strong></p>
      <ul>
        <li><strong>Order ID:</strong> ${orderData.orderId}</li>
        <li><strong>Date:</strong> ${new Date(orderData.timestamp).toLocaleString()}</li>
        <li><strong>Family Email:</strong> ${orderData.email}</li>
        <li><strong>Children:</strong> ${orderData.children ? orderData.children.length : 1}</li>
      </ul>
      
      <h3>Items Ordered by Child:</h3>
    `;
    
    let totalItems = 0;
    
    Object.keys(itemsByChild).forEach(childName => {
      const child = itemsByChild[childName];
      emailBody += `
        <h4>${childName} (${child.grade})</h4>
        <div style="margin-left: 20px;">
      `;
      
      child.items.forEach(item => {
        emailBody += `<p>‚Ä¢ ${item.name} (${item.day}) - $${item.price.toFixed(2)}</p>`;
        totalItems++;
      });
      
      emailBody += `</div>`;
    });
    
    emailBody += `
      <hr>
      <p><strong>Order Summary:</strong></p>
      <ul>
        <li><strong>Total Items:</strong> ${totalItems}</li>`;
    
    if (orderData.discount && orderData.discount > 0) {
      emailBody += `
        <li><strong>Subtotal:</strong> $${orderData.subtotal.toFixed(2)}</li>
        <li><strong>Staff Discount (10%):</strong> -$${orderData.discount.toFixed(2)}</li>
        <li><strong>Final Total:</strong> $${orderData.total.toFixed(2)}</li>`;
    } else {
      emailBody += `
        <li><strong>Total Cost:</strong> $${orderData.total.toFixed(2)}</li>`;
    }
    
    emailBody += `
        <li><strong>Payment Method:</strong> ${orderData.paymentMethod || 'Venmo'}</li>
      </ul>
      
      <p><strong>Payment Instructions:</strong><br>
      ${orderData.paymentMethod === 'Venmo' ? 'Payment sent via Venmo to @ChanTa-Rivers' : 'Payment details will be provided separately'}</p>
      
      <hr>
      <p>Questions? Contact: <a href="mailto:CRivers@artiosacademies.com">CRivers@artiosacademies.com</a></p>
      
      <p><em>This is an automated confirmation from Artios Academies of Sugar Hill. Please keep this email for your records.</em></p>
    `;
    
    GmailApp.sendEmail(
      orderData.email,
      subject,
      stripHtmlTags(emailBody),
      {
        htmlBody: emailBody,
        name: 'Artios Academies Cafe',
        charset: 'UTF-8'
      }
    );
    
    console.log('Multi-child confirmation email sent to:', orderData.email);
    
  } catch (error) {
    console.error('Error sending multi-child confirmation email:', error);
  }
}

/**
 * Send enhanced report notification email - UPDATED FOR STAFF DISCOUNT
 */
function sendEnhancedReportNotificationEmail(reportResult, reportDate, isManualReport = false, recipientEmail = null) {
  try {
    const dateString = reportDate.toDateString();
    const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][reportDate.getDay()];
    
    const subject = `${isManualReport ? 'Manual' : 'Daily'} Cafe Report - ${dayName} ${reportDate.toLocaleDateString()} (${reportResult.orderCount} items)`;
    
    const emailRecipient = recipientEmail || NOTIFICATION_EMAIL;
    
    let emailBody = `
      <html>
      <head>
        <style>
          body { font-family: 'Google Sans', Arial, sans-serif; line-height: 1.6; color: #333; }
          .header { background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
          .content { padding: 20px; background: white; }
          .summary-box { background: #f0f5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #4285f4; margin: 15px 0; }
          .highlight-box { background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #34a853; margin: 15px 0; }
          .warning-box { background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800; margin: 15px 0; }
          .discount-box { background: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0; margin: 15px 0; }
          .copy-section { background: #f44336; color: white; padding: 15px; border-radius: 8px; margin: 15px 0; }
          .copy-item { background: white; color: #333; padding: 8px; margin: 5px 0; border-radius: 4px; font-weight: bold; }
          .footer { background: #f8f9fa; padding: 15px; text-align: center; font-size: 0.9em; color: #666; border-radius: 0 0 8px 8px; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>${isManualReport ? 'Manual Admin Report' : 'Daily Cafe Report'}</h1>
          <h2>${dayName}, ${dateString}</h2>
        </div>
        
        <div class="content">
          <div class="summary-box">
            <h3>Report Summary</h3>
            <ul>
              <li><strong>Date:</strong> ${dayName}, ${dateString}</li>
              <li><strong>Items Found:</strong> ${reportResult.orderCount}</li>
              <li><strong>Generated:</strong> ${new Date().toLocaleString()} EST</li>
              <li><strong>Type:</strong> ${isManualReport ? 'Manual Admin Report' : 'Automatic Daily Report'}</li>
            </ul>
          </div>
    `;
    
    if (reportResult.orderCount > 0 && reportResult.reportData) {
      const data = reportResult.reportData;
      
      emailBody += `
          <div class="highlight-box">
            <h3>${dayName} Lunch Orders Found</h3>
            <p><strong>${reportResult.orderCount} items</strong> need to be ordered from Chick-fil-A for ${dayName}.</p>
          </div>
      `;
      
      // Add staff discount information if applicable
      if (data.totalDiscounts > 0) {
        emailBody += `
          <div class="discount-box">
            <h3>üí∞ Staff Discounts Applied</h3>
            <p><strong>Total Staff Discounts:</strong> $${data.totalDiscounts.toFixed(2)}</p>
            <p><strong>Revenue after Discounts:</strong> $${data.totalRevenue.toFixed(2)}</p>
          </div>
        `;
      }

      emailBody += `
          <div class="copy-section">
            <h3>COPY THIS TO CHICK-FIL-A ORDER</h3>
      `;
      
      Object.keys(data.itemCounts).forEach(itemName => {
        emailBody += `<div class="copy-item">${data.itemCounts[itemName].count}x ${itemName}</div>`;
      });
      
      emailBody += `</div>`;
      
    } else {
      emailBody += `
          <div class="warning-box">
            <h3>No Orders for ${dayName}</h3>
            <p><strong>No lunch orders were placed for ${dayName} ${dateString}.</strong></p>
            <p><strong>‚úÖ No Chick-fil-A order needed today!</strong></p>
          </div>
      `;
    }
    
    emailBody += `
        </div>
        <div class="footer">
          <p><strong>Artios Academies of Sugar Hill - Cafe Lunch Order System</strong></p>
          <p>Questions? Contact: <a href="mailto:CRivers@artiosacademies.com">CRivers@artiosacademies.com</a></p>
          <p><em>This report was automatically generated and sent via email only.</em></p>
        </div>
      </body>
      </html>
    `;
    
    GmailApp.sendEmail(
      emailRecipient,
      subject,
      stripHtmlTags(emailBody),
      {
        htmlBody: emailBody,
        name: 'Artios Academies Cafe System',
        charset: 'UTF-8'
      }
    );
    
    console.log(`Enhanced report email sent to ${emailRecipient} for ${dayName} ${dateString}`);
    
  } catch (error) {
    console.error('Error sending enhanced report notification email:', error);
  }
}

/**
 * Send simple cafe worker email - UPDATED FOR STAFF DISCOUNT
 */
function sendSimpleCafeWorkerEmail(reportResult, reportDate, recipientEmail) {
  try {
    const dateString = reportDate.toDateString();
    const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][reportDate.getDay()];
    
    const subject = `Cafe Orders for ${dayName} ${reportDate.toLocaleDateString()} (${reportResult.orderCount} items)`;
    
    let emailBody = '';
    let plainTextBody = '';
    
    if (reportResult.orderCount > 0 && reportResult.reportData) {
      const data = reportResult.reportData;
      
      // Create single line list of what kids ordered
      const kidOrdersList = data.itemsForThisDate.map(item => 
        `${item.studentName}: ${item.item.name}${item.promoCode ? ' (Staff Discount)' : ''}`
      ).join(', ');
      
      // Create Chick-fil-A order list
      const chickFilAOrderList = Object.keys(data.itemCounts).map(itemName => 
        `${data.itemCounts[itemName].count}x ${itemName}`
      ).join('\n');
      
      emailBody = `
        <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .header { background: #4285f4; color: white; padding: 15px; text-align: center; border-radius: 6px 6px 0 0; }
            .content { padding: 20px; background: white; }
            .section { margin: 15px 0; }
            .chick-order { background: #f44336; color: white; padding: 15px; border-radius: 6px; margin: 15px 0; }
            .order-item { background: white; color: #333; padding: 8px; margin: 3px 0; border-radius: 4px; font-weight: bold; }
            .kids-orders { background: #e8f5e8; padding: 15px; border-radius: 6px; border-left: 4px solid #34a853; }
            .discount-note { background: #f3e5f5; padding: 10px; border-radius: 6px; border-left: 4px solid #9c27b0; margin: 10px 0; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>Cafe Orders - ${dayName}</h2>
            <p>${reportResult.orderCount} items total</p>
          </div>
          
          <div class="content">
            <div class="kids-orders">
              <h3>What Kids Ordered Today:</h3>
              <p>${kidOrdersList}</p>
            </div>
            
            <div class="chick-order">
              <h3>üìã ORDER FROM CHICK-FIL-A:</h3>
              ${Object.keys(data.itemCounts).map(itemName => 
                `<div class="order-item">${data.itemCounts[itemName].count}x ${itemName}</div>`
              ).join('')}
              <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px;">
                <strong>TOTAL: ${reportResult.orderCount} items</strong>
              </div>
            </div>
            
            <div class="section">
              <p><strong>Total Revenue:</strong> $${data.totalRevenue.toFixed(2)}</p>
              <p><strong>Families Served:</strong> ${data.familiesServed}</p>`;
              
      if (data.totalDiscounts > 0) {
        emailBody += `
              <div class="discount-note">
                <strong>üí∞ Staff Discounts Applied:</strong> $${data.totalDiscounts.toFixed(2)}
              </div>`;
      }
      
      emailBody += `
            </div>
            
            <div class="section">
              <p>Questions? Contact: <a href="mailto:CRivers@artiosacademies.com">CRivers@artiosacademies.com</a></p>
            </div>
          </div>
        </body>
        </html>
      `;
      
      plainTextBody = `
CAFE ORDERS - ${dayName} ${dateString}
${reportResult.orderCount} items total

WHAT KIDS ORDERED TODAY:
${kidOrdersList}

ORDER FROM CHICK-FIL-A:
${chickFilAOrderList}

TOTAL: ${reportResult.orderCount} items
Total Revenue: $${data.totalRevenue.toFixed(2)}
${data.totalDiscounts > 0 ? `Staff Discounts: $${data.totalDiscounts.toFixed(2)}\n` : ''}Families Served: ${data.familiesServed}

Questions? Contact: CRivers@artiosacademies.com
      `.trim();
      
    } else {
      // No orders found
      emailBody = `
        <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .header { background: #ff9800; color: white; padding: 15px; text-align: center; border-radius: 6px 6px 0 0; }
            .content { padding: 20px; background: white; }
            .no-orders { background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ff9800; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>No Cafe Orders - ${dayName}</h2>
          </div>
          
          <div class="content">
            <div class="no-orders">
              <h3>No Orders for ${dayName}</h3>
              <p><strong>‚úÖ No Chick-fil-A order needed today!</strong></p>
              <p>No lunch orders were placed for this date.</p>
            </div>
            
            <div class="section">
              <p>Questions? Contact: <a href="mailto:CRivers@artiosacademies.com">CRivers@artiosacademies.com</a></p>
            </div>
          </div>
        </body>
        </html>
      `;
      
      plainTextBody = `
NO CAFE ORDERS - ${dayName} ${dateString}

‚úÖ No Chick-fil-A order needed today!
No lunch orders were placed for this date.

Questions? Contact: CRivers@artiosacademies.com
      `.trim();
    }
    
    // Send email
    GmailApp.sendEmail(
      recipientEmail,
      subject,
      plainTextBody,
      {
        htmlBody: emailBody,
        name: 'Artios Academies Cafe System',
        charset: 'UTF-8'
      }
    );
    
    console.log(`Simple cafe worker email sent to ${recipientEmail} for ${dayName} ${dateString}`);
    
  } catch (error) {
    console.error('Error sending simple cafe worker email:', error);
    // Don't throw error - email failure shouldn't break report generation
  }
}

// ============================================
// HELPER FUNCTIONS - UNCHANGED
// ============================================
/**
 * Strip HTML tags for plain text email version
 */
function stripHtmlTags(html) {
  return html
    .replace(/<[^>]*>/g, '')
    .replace(/&nbsp;/g, ' ')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&amp;/g, '&')
    .replace(/\s+/g, ' ')
    .trim();
}

/**
 * Get Monday of the week containing the given date
 */
function getMonday(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  d.setDate(diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

/**
 * Convert day name to actual date based on week start
 */
function getDateFromDayName(dayName, weekStart) {
  const dayMap = {
    'Monday': 1,
    'Tuesday': 2,
    'Wednesday': 3,
    'Thursday': 4,
    'Friday': 5
  };
  
  const monday = getMonday(new Date(weekStart));
  const targetDay = new Date(monday);
  const dayOffset = dayMap[dayName] - 1;
  
  if (dayOffset !== undefined) {
    targetDay.setDate(monday.getDate() + dayOffset);
  }
  
  return targetDay;
}

// ============================================
// DAILY AUTOMATION - UNCHANGED
// ============================================
/**
 * Daily order compilation (automatically runs at 8:05 AM EST)
 */
function compileDailyOrders() {
  try {
    const today = new Date();
    
    console.log(`Compiling daily multi-child orders for ${today.toDateString()}`);
    
    const result = generateEmailOnlyReport(today);
    
    sendEnhancedReportNotificationEmail(result, today, false);
    
    console.log(`‚úÖ Daily multi-child report sent via email: ${result.orderCount} items for ${today.toDateString()}`);
    console.log(`üìß Enhanced email notification sent to ${NOTIFICATION_EMAIL}`);
    
  } catch (error) {
    console.error('Error in daily compilation:', error);
    
    try {
      GmailApp.sendEmail(
        NOTIFICATION_EMAIL,
        '‚ùå Daily Cafe Report Generation Failed',
        `Error generating daily report for ${new Date().toDateString()}:\n\n${error.toString()}\n\nPlease check the Google Apps Script logs.`,
        { name: 'Artios Academies Cafe System' }
      );
    } catch (emailError) {
      console.error('Failed to send error notification email:', emailError);
    }
  }
}
