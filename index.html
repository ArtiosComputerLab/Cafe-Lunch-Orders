<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cafe Lunch Order Form 2025-2026</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2em;
      font-weight: 400;
      margin-bottom: 10px;
    }

    .header .notice {
      background: rgba(255,255,255,0.15);
      padding: 15px;
      border-radius: 8px;
      font-size: 0.9em;
      margin-top: 15px;
    }

    .sync-status {
      position: absolute;
      top: 10px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
    }

    .store-status {
      position: absolute;
      top: 10px;
      left: 20px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
    }

    .main-content {
      display: flex;
      min-height: calc(100vh - 140px);
    }

    .form-section {
      flex: 2;
      padding: 30px;
    }

    .form-section {
      background: white;
    }

    /* Shared Email Section */
    .shared-email {
      background: #e8f5e8;
      border: 2px solid #4caf50;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .shared-email h3 {
      color: #2e7d32;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Child Section Styles */
    .child-section {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      transition: all 0.3s ease;
    }

    .child-section:hover {
      border-color: #4285f4;
    }

    .child-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .child-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #4285f4;
      display: flex;
      align-items: center;
    }

    .child-icon {
      background: #4285f4;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .remove-child {
      background: #ff5722;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .remove-child:hover {
      background: #d32f2f;
      transform: scale(1.1);
    }

    /* Form Elements */
    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      flex: 1;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #444;
    }

    .required {
      color: #d32f2f;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .add-child-btn {
      background: #34a853;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 30px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      width: 100%;
      max-width: 300px;
    }

    .add-child-btn:hover {
      background: #2e7d32;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
    }

    /* Menu Section */
    .menu-section {
      margin-top: 30px;
    }

    .menu-section h3 {
      color: #4285f4;
      margin-bottom: 20px;
      font-size: 1.3em;
    }

    .day-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
    }

    .day-tab {
      padding: 15px 25px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-weight: 500;
      color: #666;
    }

    .day-tab:hover {
      background: rgba(66, 133, 244, 0.1);
      color: #4285f4;
    }

    .day-tab.active {
      color: #4285f4;
      border-bottom-color: #4285f4;
      background: rgba(66, 133, 244, 0.1);
    }

    .day-tab.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .menu-for-day {
      display: none;
    }

    .menu-for-day.active {
      display: block;
    }

    .menu-category {
      margin-bottom: 30px;
    }

    .menu-category h4 {
      color: #34a853;
      margin-bottom: 15px;
      font-size: 1.1em;
      padding: 10px;
      background: rgba(52, 168, 83, 0.1);
      border-radius: 6px;
    }

    .menu-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .menu-item:hover {
      border-color: #4285f4;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .item-name {
      font-weight: 600;
      color: #333;
    }

    .item-price {
      font-weight: 700;
      color: #34a853;
      font-size: 1.1em;
    }

    .item-desc {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 15px;
    }

    .child-checkboxes {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .child-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 6px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .child-checkbox:has(input:checked) {
      background: rgba(66, 133, 244, 0.1);
      border-color: #4285f4;
    }

    .child-checkbox input {
      width: auto;
      margin: 0;
    }

    .child-checkbox label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
      color: #4285f4;
    }

    /* Sidebar */
    .sidebar {
      flex: 1;
      background: #f8f9fa;
      border-left: 1px solid #e0e0e0;
      padding: 30px;
    }

    .cart-summary {
      position: sticky;
      top: 30px;
    }

    .cart-title {
      font-size: 1.4em;
      font-weight: 600;
      color: #4285f4;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .history-btn {
      width: 100%;
      background: white;
      color: #4285f4;
      border: 2px solid #4285f4;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .history-btn:hover {
      background: #4285f4;
      color: white;
    }

    .cart-items {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding-right: 10px;
    }

    .empty-cart {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-style: italic;
    }

    .child-cart-section {
      margin-bottom: 20px;
    }

    .child-cart-header {
      background: #4285f4;
      color: white;
      padding: 10px 15px;
      border-radius: 6px 6px 0 0;
      font-weight: 600;
      font-size: 0.9em;
    }

    .cart-item {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cart-item:last-child {
      border-radius: 0 0 6px 6px;
    }

    .cart-item-name {
      font-weight: 500;
      color: #333;
      flex: 1;
    }

    .cart-item-price {
      font-weight: 700;
      color: #34a853;
    }

    .cart-total {
      background: white;
      border: 2px solid #4285f4;
      border-radius: 8px;
      padding: 20px;
    }

    .total-label {
      font-size: 1.1em;
      font-weight: 600;
      color: #4285f4;
      margin-bottom: 10px;
    }

    .total-amount {
      font-size: 2em;
      font-weight: 700;
      color: #34a853;
      margin-bottom: 20px;
    }

    .checkout-btn {
      width: 100%;
      background: #34a853;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .checkout-btn:hover:not(:disabled) {
      background: #2e7d32;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
    }

    .checkout-btn:disabled {
      background: #bbb;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Payment Modal */
    .payment-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .payment-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
    }

    .payment-header {
      font-size: 1.5em;
      font-weight: 600;
      color: #4285f4;
      margin-bottom: 15px;
    }

    .payment-amount {
      font-size: 2em;
      font-weight: 700;
      color: #34a853;
      margin-bottom: 25px;
    }

    .payment-steps {
      text-align: left;
      margin-bottom: 25px;
    }

    .payment-step {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .step-number {
      background: #4285f4;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9em;
      flex-shrink: 0;
    }

    .venmo-btn {
      display: inline-block;
      background: #3d95ce;
      color: white;
      text-decoration: none;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      margin: 10px 0;
    }

    .venmo-btn:hover {
      background: #357ca5;
      transform: translateY(-2px);
    }

    .confirmation-btn {
      background: #34a853;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 10px;
      transition: all 0.3s ease;
    }

    .confirmation-btn:hover {
      background: #2e7d32;
    }

    .cancel-btn {
      background: #666;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 10px;
      transition: all 0.3s ease;
    }

    .cancel-btn:hover {
      background: #555;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 1001;
      animation: slideIn 0.3s ease;
      max-width: 300px;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }

      .form-section, .sidebar {
        flex: none;
      }

      .sidebar {
        border-left: none;
        border-top: 1px solid #e0e0e0;
      }

      .form-row {
        flex-direction: column;
        gap: 15px;
      }

      .day-tabs {
        overflow-x: scroll;
      }

      .child-checkboxes {
        flex-direction: column;
      }

      .payment-content {
        margin: 20px;
        width: calc(100% - 40px);
      }

      .header h1 {
        font-size: 1.5em;
      }

      .sync-status, .store-status {
        position: relative;
        top: auto;
        left: auto;
        right: auto;
        display: inline-block;
        margin: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="store-status" id="store-status">
        Checking store hours...
      </div>
      <div class="sync-status">
        ☁️ Cloud Sync Active
      </div>
      
      <h1>🍽️ Cafe Lunch Order Form 2025-2026</h1>
      <div class="notice">
        <strong>Order & Payment Cutoff: Daily at 8:00 AM</strong><br>
        ONE FORM PER FAMILY • Order for multiple children with one email<br>
        Form closed daily from 8:00 AM - 1:00 PM<br>
        Contact: CRivers@artiosacademies.com
      </div>
    </div>

    <div class="main-content">
      <div class="form-section">
        <!-- Shared Email Section -->
        <div class="shared-email">
          <h3>📧 Family Email</h3>
          <div class="form-group">
            <label for="family-email">Email Address <span class="required">*</span></label>
            <input type="email" id="family-email" required placeholder="parent@example.com">
          </div>
        </div>

        <!-- Children Sections -->
        <div id="children-container">
          <div class="child-section" data-child="1">
            <div class="child-header">
              <div class="child-title">
                <div class="child-icon">1</div>
                Child 1
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>First Name <span class="required">*</span></label>
                <input type="text" class="child-first-name" required>
              </div>
              <div class="form-group">
                <label>Last Name <span class="required">*</span></label>
                <input type="text" class="child-last-name" required>
              </div>
              <div class="form-group">
                <label>Grade <span class="required">*</span></label>
                <select class="child-grade" required>
                  <option value="">Select Grade</option>
                  <option value="K-2">K-2</option>
                  <option value="3-4">3-4</option>
                  <option value="5-6">5-6</option>
                  <option value="7-8">7-8</option>
                  <option value="9-12">9-12</option>
                  <option value="Staff">Staff</option>
                  <option value="Parent">Parent</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="add-child-btn" id="add-child-btn">
          <span>➕ </span> Add Another Child
        </button>

        <div class="menu-section">
          <h3>Select Days & Menu Items</h3>

          <div class="day-tabs" id="day-tabs">
            <!-- Tabs will be generated by JavaScript -->
          </div>

          <div id="menu-container">
            <!-- Menu for each day will be generated by JavaScript -->
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="cart-summary">
          <div class="cart-title">🛒 Your Order</div>
          <button type="button" class="history-btn" id="history-btn">
            View Order History
          </button>

          <!-- Secret Report Generation Button -->
          <button type="button" class="history-btn" id="secret-report-btn" style="display: none; background: #ff9800; color: white; border-color: #ff9800;">
            📊 Generate Test Report
          </button>
          <div class="cart-items" id="cart-items">
            <div class="empty-cart">No items selected</div>
          </div>
          <div class="cart-total">
            <div class="total-label">Order Total</div>
            <div class="total-amount">$<span id="total-amount">0.00</span></div>
            <button type="button" class="checkout-btn" id="checkout-btn" disabled>
              Review & Pay Order
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="payment-modal" id="payment-modal">
    <div class="payment-content">
      <div class="payment-header">Complete Your Order</div>
      <div class="payment-amount">
        Total: $<span id="modal-total">0.00</span>
      </div>

      <div class="payment-steps">
        <div class="payment-step">
          <div class="step-number">1</div>
          <div>Click "Pay with Venmo" to open Venmo with order details</div>
        </div>
        <div class="payment-step">
          <div class="step-number">2</div>
          <div>Complete payment to <strong>@ChanTa-Rivers</strong></div>
        </div>
        <div class="payment-step">
          <div class="step-number">3</div>
          <div>Return here and click "I've Paid" to submit your order</div>
        </div>
      </div>

      <div style="margin: 20px 0;">
        <a href="#" id="venmo-payment-link" class="venmo-btn">
          💳 Pay with Venmo ($<span id="venmo-total">0.00</span>)
        </a>
      </div>

      <div style="border-top: 1px solid #e0e0e0; padding-top: 20px;">
        <button type="button" class="confirmation-btn" id="confirm-payment-btn">
          ✅ I've Paid - Submit Order
        </button>
        <button type="button" class="cancel-btn" id="cancel-payment-btn">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION - UPDATE THIS SECTION
    // ============================================
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec',
      useGoogleSheets: true,
      fallbackToLocalStorage: true
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let currentTotal = 0;
    let orderItems = [];
    let currentDay = 'monday';
    let storeIsOpen = true;
    let cloudSyncActive = false;
    let childCount = 1;

    // Menu data structure
    const menuData = {
      entrees: [
        { id: 'chicken-sandwich', name: 'Chicken Sandwich', price: 6.50, desc: 'Classic boneless breast of chicken' },
        { id: 'spicy-chicken', name: 'Spicy Chicken Sandwich', price: 6.75, desc: 'Boneless breast with spicy seasoning' },
        { id: 'nuggets-8', name: 'Nuggets (8ct)', price: 6.50, desc: 'Bite-sized boneless chicken pieces' },
        { id: 'grilled-nuggets', name: 'Grilled Nuggets (8ct)', price: 7.50, desc: 'Grilled boneless chicken pieces' },
        { id: 'grilled-sandwich', name: 'Grilled Sandwich', price: 8.25, desc: 'Grilled chicken breast sandwich' },
        { id: 'grilled-gf', name: 'Grilled Sandwich (GF Bun)', price: 9.50, desc: 'Grilled chicken with gluten-free bun' },
        { id: 'chicken-wrap', name: 'Chicken Wrap', price: 9.75, desc: 'Grilled chicken in tortilla wrap' },
        { id: 'veggie-wrap', name: 'Southwest Veggie Wrap', price: 9.50, desc: 'Vegetarian wrap with southwest flavors' },
        { id: 'chicken-strips', name: 'Chicken Strips (3ct)', price: 6.75, desc: 'Hand-breaded chicken strips' }
      ],
      addons: [
        { id: 'chips-drink', name: 'Chips & Drink', price: 1.50, desc: 'Add chips and drink to any entree' },
        { id: 'fries-drink', name: 'Fries & Drink', price: 3.75, desc: 'Add fries and drink to any entree' },
        { id: 'fruit-drink', name: 'Fruit Cup & Drink', price: 5.50, desc: 'Add fruit cup and drink to any entree' },
        { id: 'mac-drink', name: 'Mac & Cheese & Drink', price: 5.50, desc: 'Add mac & cheese and drink to any entree' },
        { id: 'salad-drink', name: 'Side Salad & Drink', price: 5.50, desc: 'Add side salad and drink to any entree' },
        { id: 'parfait-drink', name: 'Cookie Parfait & Drink', price: 5.75, desc: 'Add cookie parfait and drink to any entree' }
      ],
      sides: [
        { id: 'fries-only', name: 'Fries', price: 3.75, desc: 'Waffle potato fries' },
        { id: 'fruit-only', name: 'Fruit Cup', price: 5.50, desc: 'Fresh seasonal fruit' },
        { id: 'mac-only', name: 'Mac & Cheese', price: 5.50, desc: 'Creamy macaroni and cheese' },
        { id: 'salad-only', name: 'Side Salad', price: 5.50, desc: 'Mixed greens with toppings' },
        { id: 'parfait-only', name: 'Cookie Parfait', price: 5.75, desc: 'Cookie pieces with cream' }
      ],
      salads: [
        { id: 'cobb-salad', name: 'Cobb Salad', price: 11.25, desc: 'Mixed greens with chicken, bacon, cheese, and more' },
        { id: 'southwest-salad', name: 'Southwest Salad', price: 11.50, desc: 'Mixed greens with chicken, corn, peppers' },
        { id: 'market-salad', name: 'Market Fresh Salad', price: 11.50, desc: 'Mixed greens with chicken and seasonal toppings' }
      ]
    };

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      checkStoreHours();
      generateDayTabs();
      generateMenus();
      setupEventListeners();
      updateCart();
      validateForm();
      
      // Show secret report button in development
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        document.getElementById('secret-report-btn').style.display = 'block';
      }
    });

    function checkStoreHours() {
      const now = new Date();
      const hours = now.getHours();
      const storeStatus = document.getElementById('store-status');
      
      // Store is CLOSED from 8:00 AM to 1:00 PM (8-13)
      if (hours >= 8 && hours < 13) {
        storeIsOpen = false;
        storeStatus.textContent = '🔒 Store Closed (8 AM - 1 PM)';
        storeStatus.style.background = 'rgba(244, 67, 54, 0.8)';
        
        // Disable the form
        document.body.style.pointerEvents = 'none';
        document.body.style.opacity = '0.7';
        
        const notice = document.querySelector('.notice');
        notice.innerHTML = `
          <strong style="color: #ff5722;">⚠️ ORDERING CLOSED</strong><br>
          Form reopens daily at 1:00 PM<br>
          Current time: ${now.toLocaleTimeString()}<br>
          Contact: CRivers@artiosacademies.com
        `;
      } else {
        storeIsOpen = true;
        storeStatus.textContent = '✅ Store Open - Orders Accepted';
        storeStatus.style.background = 'rgba(76, 175, 80, 0.8)';
      }
    }

    function generateDayTabs() {
      const tabsContainer = document.getElementById('day-tabs');
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
      const today = new Date();
      const currentHour = today.getHours();
      
      days.forEach((day, index) => {
        const tab = document.createElement('div');
        tab.className = 'day-tab';
        tab.dataset.day = day.toLowerCase();
        
        const dayDate = new Date(today);
        dayDate.setDate(today.getDate() + index);
        const dateStr = `${dayDate.getMonth() + 1}/${dayDate.getDate()}`;
        
        // Disable past days after 8 AM cutoff
        const isPastDay = index === 0 && currentHour >= 8;
        
        tab.innerHTML = `
          <div>${day}</div>
          <div style="font-size: 0.8em; opacity: 0.8;">${dateStr}</div>
        `;
        
        if (isPastDay) {
          tab.classList.add('disabled');
          tab.title = 'Orders for today close at 8:00 AM';
        } else {
          tab.addEventListener('click', () => switchDay(day.toLowerCase()));
        }
        
        if (index === (isPastDay ? 1 : 0)) {
          tab.classList.add('active');
          currentDay = day.toLowerCase();
        }
        
        tabsContainer.appendChild(tab);
      });
    }

    function generateMenus() {
      const container = document.getElementById('menu-container');
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
      
      days.forEach(day => {
        const dayMenu = document.createElement('div');
        dayMenu.className = 'menu-for-day';
        dayMenu.dataset.day = day;
        
        if (day === currentDay) {
          dayMenu.classList.add('active');
        }
        
        // Generate menu categories
        Object.keys(menuData).forEach(category => {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'menu-category';
          
          const categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
          categoryDiv.innerHTML = `<h4>${categoryTitle}</h4>`;
          
          menuData[category].forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item';
            
            itemDiv.innerHTML = `
              <div class="item-header">
                <div class="item-name">${item.name}</div>
                <div class="item-price">$${item.price.toFixed(2)}</div>
              </div>
              <div class="item-desc">${item.desc}</div>
              <div class="child-checkboxes" id="${item.id}-${day}-checkboxes"></div>
            `;
            
            categoryDiv.appendChild(itemDiv);
          });
          
          dayMenu.appendChild(categoryDiv);
        });
        
        container.appendChild(dayMenu);
      });
      
      updateChildCheckboxes();
    }

    function switchDay(day) {
      document.querySelectorAll('.day-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.day === day) {
          tab.classList.add('active');
        }
      });

      document.querySelectorAll('.menu-for-day').forEach(menu => {
        menu.classList.remove('active');
        if (menu.dataset.day === day) {
          menu.classList.add('active');
        }
      });

      currentDay = day;
    }

    // ============================================
    // MULTI-CHILD FUNCTIONALITY
    // ============================================
    function setupEventListeners() {
      document.getElementById('add-child-btn').addEventListener('click', addChild);

      document.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' && e.target.dataset.item) {
          updateCart();
        }
      });

      document.addEventListener('input', function(e) {
        if (e.target.classList.contains('child-first-name') || 
            e.target.classList.contains('child-last-name')) {
          updateChildCheckboxes();
        }
        if (e.target.id === 'family-email') {
          checkOrderHistory();
        }
        validateForm();
      });

      document.getElementById('checkout-btn').addEventListener('click', openPaymentModal);
      document.getElementById('history-btn').addEventListener('click', showOrderHistory);
      document.getElementById('secret-report-btn').addEventListener('click', generateTestReport);
      document.getElementById('cancel-payment-btn').addEventListener('click', closePaymentModal);
      document.getElementById('confirm-payment-btn').addEventListener('click', submitOrder);

      document.getElementById('payment-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          closePaymentModal();
        }
      });
    }

    function addChild() {
      childCount++;
      const container = document.getElementById('children-container');
      
      const childDiv = document.createElement('div');
      childDiv.className = 'child-section';
      childDiv.dataset.child = childCount;
      
      childDiv.innerHTML = `
        <div class="child-header">
          <div class="child-title">
            <div class="child-icon">${childCount}</div>
            Child ${childCount}
          </div>
          <button type="button" class="remove-child" onclick="removeChild(${childCount})">✕</button>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>First Name <span class="required">*</span></label>
            <input type="text" class="child-first-name" required>
          </div>
          <div class="form-group">
            <label>Last Name <span class="required">*</span></label>
            <input type="text" class="child-last-name" required>
          </div>
          <div class="form-group">
            <label>Grade <span class="required">*</span></label>
            <select class="child-grade" required>
              <option value="">Select Grade</option>
              <option value="K-2">K-2</option>
              <option value="3-4">3-4</option>
              <option value="5-6">5-6</option>
              <option value="7-8">7-8</option>
              <option value="9-12">9-12</option>
              <option value="Staff">Staff</option>
              <option value="Parent">Parent</option>
            </select>
          </div>
        </div>
      `;
      
      container.appendChild(childDiv);
      updateChildCheckboxes();
      validateForm();
    }

    function removeChild(childId) {
      const childSection = document.querySelector(`[data-child="${childId}"]`);
      if (childSection && childCount > 1) {
        // Remove items for this child from cart
        orderItems = orderItems.filter(item => item.childId !== childId.toString());
        
        childSection.remove();
        renumberChildren();
        updateChildCheckboxes();
        updateCart();
      }
    }

    function renumberChildren() {
      const childSections = document.querySelectorAll('.child-section');
      childCount = childSections.length;
      
      childSections.forEach((section, index) => {
        const newChildId = index + 1;
        section.dataset.child = newChildId;
        section.querySelector('.child-icon').textContent = newChildId;
        section.querySelector('.child-title').lastChild.textContent = ` Child ${newChildId}`;
        const removeBtn = section.querySelector('.remove-child');
        if (removeBtn) {
          removeBtn.setAttribute('onclick', `removeChild(${newChildId})`);
        }
      });
    }

    function updateChildCheckboxes() {
      const children = document.querySelectorAll('.child-section');
      
      document.querySelectorAll('.child-checkboxes').forEach(container => {
        const parts = container.id.split('-');
        const day = parts[parts.length - 2];
        const itemId = parts.slice(0, -2).join('-');
        
        container.innerHTML = '';
        
        children.forEach(child => {
          const childId = child.dataset.child;
          const firstName = child.querySelector('.child-first-name').value || `Child ${childId}`;
          
          const checkboxContainer = document.createElement('div');
          checkboxContainer.className = 'child-checkbox';
          
          const checkboxId = `${itemId}-${day}-child-${childId}`;
          
          checkboxContainer.innerHTML = `
            <input type="checkbox" 
                   id="${checkboxId}"
                   data-item="${itemId}"
                   data-day="${day}"
                   data-child-id="${childId}">
            <label for="${checkboxId}">${firstName}</label>
          `;
          
          container.appendChild(checkboxContainer);
        });
      });
    }

    // ============================================
    // CART MANAGEMENT
    // ============================================
    function updateCart() {
      orderItems = [];
      currentTotal = 0;
      
      document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        const itemId = checkbox.dataset.item;
        const day = checkbox.dataset.day;
        const childId = checkbox.dataset.childId;
        
        const child = document.querySelector(`[data-child="${childId}"]`);
        const childFirstName = child.querySelector('.child-first-name').value;
        const childLastName = child.querySelector('.child-last-name').value;
        const childGrade = child.querySelector('.child-grade').value;
        
        // Find item in menu data
        let item = null;
        Object.values(menuData).forEach(category => {
          const found = category.find(i => i.id === itemId);
          if (found) item = found;
        });
        
        if (item) {
          orderItems.push({
            childId: childId,
            childName: `${childFirstName} ${childLastName}`,
            firstName: childFirstName,
            lastName: childLastName,
            grade: childGrade,
            name: item.name,
            price: item.price,
            day: day.charAt(0).toUpperCase() + day.slice(1)
          });
          
          currentTotal += item.price;
        }
      });
      
      displayCart();
      validateForm();
    }

    function displayCart() {
      const cartItemsDiv = document.getElementById('cart-items');
      const totalSpan = document.getElementById('total-amount');
      
      if (orderItems.length === 0) {
        cartItemsDiv.innerHTML = '<div class="empty-cart">No items selected</div>';
        totalSpan.textContent = '0.00';
        return;
      }
      
      // Group by child
      const itemsByChild = {};
      orderItems.forEach(item => {
        if (!itemsByChild[item.childId]) {
          itemsByChild[item.childId] = {
            name: item.childName,
            items: []
          };
        }
        itemsByChild[item.childId].items.push(item);
      });
      
      let html = '';
      Object.keys(itemsByChild).sort((a, b) => parseInt(a) - parseInt(b)).forEach(childId => {
        const child = itemsByChild[childId];
        html += `<div class="child-cart-section">`;
        html += `<div class="child-cart-header">${child.name}</div>`;
        
        child.items.forEach(item => {
          html += `
            <div class="cart-item">
              <div class="cart-item-name">${item.name} (${item.day})</div>
              <div class="cart-item-price">$${item.price.toFixed(2)}</div>
            </div>
          `;
        });
        html += `</div>`;
      });
      
      cartItemsDiv.innerHTML = html;
      totalSpan.textContent = currentTotal.toFixed(2);
    }

    function validateForm() {
      const email = document.getElementById('family-email').value.trim();
      const checkoutBtn = document.getElementById('checkout-btn');
      
      // Check if we have items and required info
      const hasItems = orderItems.length > 0;
      const hasEmail = email.length > 0;
      
      // Check if all children have required info
      const children = document.querySelectorAll('.child-section');
      let allChildrenComplete = true;
      children.forEach(child => {
        const firstName = child.querySelector('.child-first-name').value.trim();
        const lastName = child.querySelector('.child-last-name').value.trim();
        const grade = child.querySelector('.child-grade').value;
        if (!firstName || !lastName || !grade) {
          allChildrenComplete = false;
        }
      });
      
      const isValid = hasItems && hasEmail && allChildrenComplete;
      checkoutBtn.disabled = !isValid;
    }

    // ============================================
    // PAYMENT & ORDER SUBMISSION
    // ============================================
    function openPaymentModal() {
      if (!validateForm()) return;
      
      const modal = document.getElementById('payment-modal');
      const modalTotal = document.getElementById('modal-total');
      const venmoTotal = document.getElementById('venmo-total');
      const venmoLink = document.getElementById('venmo-payment-link');
      
      modalTotal.textContent = currentTotal.toFixed(2);
      venmoTotal.textContent = currentTotal.toFixed(2);
      
      // Create order summary for Venmo
      let orderSummary = `Cafe Lunch Order - $${currentTotal.toFixed(2)}`;
      const children = [...new Set(orderItems.map(item => item.childName))];
      if (children.length <= 2) {
        orderSummary += ` for ${children.join(' & ')}`;
      } else {
        orderSummary += ` for ${children.length} children`;
      }
      
      // Generate Venmo URL
      const venmoUrl = `venmo://paycharge?txn=pay&recipients=ChanTa-Rivers&amount=${currentTotal.toFixed(2)}&note=${encodeURIComponent(orderSummary)}`;
      const venmoWebUrl = `https://venmo.com/ChanTa-Rivers?txn=pay&amount=${currentTotal.toFixed(2)}&note=${encodeURIComponent(orderSummary)}`;
      
      // Try to detect mobile for Venmo app link
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        venmoLink.href = venmoUrl;
      } else {
        venmoLink.href = venmoWebUrl;
        venmoLink.target = '_blank';
        
        const paymentDetails = `Pay @ChanTa-Rivers $${currentTotal.toFixed(2)} for: ${orderSummary}`;
        
        venmoLink.addEventListener('click', function(e) {
          e.preventDefault();
          window.open(venmoWebUrl, '_blank');
          
          // Try to copy payment details to clipboard
          if (navigator.clipboard) {
            navigator.clipboard.writeText(paymentDetails).then(() => {
              alert('Payment details copied to clipboard!\n\n' + paymentDetails);
            }).catch(() => {
              alert('Please send payment to:\n\n' + paymentDetails);
            });
          } else {
            alert('Please send payment to:\n\n' + paymentDetails);
          }
        });
      }
      
      modal.style.display = 'flex';
    }

    function closePaymentModal() {
      document.getElementById('payment-modal').style.display = 'none';
    }

    // ============================================
    // FIXED SUBMIT ORDER FUNCTION
    // ============================================
    function submitOrder() {
      // Create order data structure for multi-child orders
      const orderData = {
        orderId: `LO${Date.now()}${Math.random().toString(36).substr(2, 5).toUpperCase()}`,
        timestamp: new Date().toISOString(),
        email: document.getElementById('family-email').value.trim(),
        children: [],
        items: orderItems,
        total: currentTotal,
        paymentMethod: 'Venmo',
        paymentStatus: 'confirmed',
        sendConfirmation: true,
        weekStart: getWeekStartDate()
      };

      // Add children data
      document.querySelectorAll('.child-section').forEach(child => {
        orderData.children.push({
          id: child.dataset.child,
          firstName: child.querySelector('.child-first-name').value.trim(),
          lastName: child.querySelector('.child-last-name').value.trim(),
          grade: child.querySelector('.child-grade').value
        });
      });

      showNotification('Submitting multi-child order...', 'info');

      // **FIXED**: Actually submit to Google Sheets instead of demo mode
      if (GOOGLE_SHEETS_CONFIG.useGoogleSheets && GOOGLE_SHEETS_CONFIG.webAppUrl) {
        fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(orderData)
        })
        .then(() => {
          // Success - order submitted to Google Sheets
          closePaymentModal();
          showNotification(`Order ${orderData.orderId} submitted successfully!`, 'success');
          
          // Show detailed confirmation
          showDetailedOrderConfirmation(orderData);
          
          // Reset form for next order
          resetMultiChildForm();
        })
        .catch(error => {
          console.error('Error submitting to Google Sheets:', error);
          showNotification('Error submitting order. Please try again.', 'error');
        });
      } else {
        // Fallback if Google Sheets not configured
        showNotification('Google Sheets integration not configured', 'error');
        console.error('GOOGLE_SHEETS_CONFIG is not properly configured');
      }
    }

    // Helper function to get the week start date (Monday)
    function getWeekStartDate() {
      const today = new Date();
      const day = today.getDay();
      const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
      const monday = new Date(today.setDate(diff));
      monday.setHours(0, 0, 0, 0);
      return monday.toISOString();
    }

    // Show detailed order confirmation
    function showDetailedOrderConfirmation(orderData) {
      let confirmationMessage = `✅ ORDER CONFIRMED!\n\nOrder ID: ${orderData.orderId}\nTotal: $${orderData.total.toFixed(2)}\n\nChildren:\n`;
      
      orderData.children.forEach(child => {
        confirmationMessage += `• ${child.firstName} ${child.lastName} (${child.grade})\n`;
      });
      
      confirmationMessage += `\nItems Ordered:\n`;
      orderData.items.forEach(item => {
        const child = orderData.children.find(c => c.id === item.childId);
        const childName = child ? `${child.firstName} ${child.lastName}` : 'Unknown';
        confirmationMessage += `• ${item.name} (${item.day}) - ${childName} - $${item.price.toFixed(2)}\n`;
      });
      
      confirmationMessage += `\nPayment: ${orderData.paymentMethod}\n`;
      confirmationMessage += `\nA confirmation email will be sent to: ${orderData.email}`;
      
      alert(confirmationMessage);
    }

    // Reset the form after successful submission
    function resetMultiChildForm() {
      // Clear email
      document.getElementById('family-email').value = '';
      
      // Reset all child sections
      document.querySelectorAll('.child-section').forEach(child => {
        child.querySelector('.child-first-name').value = '';
        child.querySelector('.child-last-name').value = '';
        child.querySelector('.child-grade').value = '';
      });
      
      // Clear all menu selections
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Reset order state
      orderItems = [];
      currentTotal = 0;
      
      // Update displays
      updateCart();
      validateForm();
      
      showNotification('Form reset - ready for next order', 'info');
    }

    // ============================================
    // ORDER HISTORY & REPORTING
    // ============================================
    function checkOrderHistory() {
      // This would check for existing orders for the email
      // Implementation depends on whether using Google Sheets or localStorage
    }

    function showOrderHistory() {
      const email = document.getElementById('family-email').value.trim();
      if (!email) {
        alert('Please enter your email address to view order history.');
        return;
      }
      
      alert('Order history feature coming soon!');
    }

    function generateTestReport() {
      const dateInput = prompt('Generate report for which date?\n\nFormat: YYYY-MM-DD\nExample: 2025-08-06', 
                               new Date().toISOString().split('T')[0]);
      
      if (!dateInput) return;
      
      showNotification('🔄 Generating report for ' + dateInput + '...', 'info');
      
      const reportUrl = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=generate_report&secret=cafe2025&date=${dateInput}`;
      
      fetch(reportUrl)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const message = `✅ Report Generated Successfully!\n\n` +
                          `Date: ${dateInput}\n` +
                          `Sheet: ${data.sheetName}\n` +
                          `Orders Found: ${data.ordersProcessed}\n\n` +
                          `${data.sheetUrl ? 'Opening Google Sheet...' : ''}`;
            
            alert(message);
            
            if (data.ordersProcessed > 0) {
              showNotification(`Report created: ${data.ordersProcessed} orders for ${dateInput}`, 'success');
            } else {
              showNotification(`No orders found for ${dateInput}`, 'warning');
            }
            
            if (data.sheetUrl) {
              setTimeout(() => {
                if (confirm('Open the Google Sheet to view the report?')) {
                  window.open(data.sheetUrl, '_blank');
                }
              }, 1000);
            }
          } else {
            showNotification(`Report generation failed: ${data.error}`, 'error');
            console.error('Report error:', data.error);
          }
        })
        .catch(error => {
          showNotification('Error generating report', 'error');
          console.error('Report generation error:', error);
        });
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function showNotification(message, type = 'info') {
      const existingNotif = document.querySelector('.notification');
      if (existingNotif) {
        existingNotif.remove();
      }
      
      let bgColor, textColor, borderColor, icon;
      switch(type) {
        case 'success':
          bgColor = '#d4edda';
          textColor = '#155724';
          borderColor = '#c3e6cb';
          icon = '✅ ';
          break;
        case 'error':
          bgColor = '#f8d7da';
          textColor = '#721c24';
          borderColor = '#f5c6cb';
          icon = '❌ ';
          break;
        case 'warning':
          bgColor = '#fff3cd';
          textColor = '#856404';
          borderColor = '#ffeaa7';
          icon = '⚠️ ';
          break;
        default:
          bgColor = '#e3f2fd';
          textColor = '#1976d2';
          borderColor = '#bbdefb';
          icon = 'ℹ️ ';
      }
      
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.style.cssText = `
        background: ${bgColor};
        color: ${textColor};
        border: 2px solid ${borderColor};
      `;
      notif.textContent = icon + message;
      
      document.body.appendChild(notif);
      
      setTimeout(() => {
        if (notif.parentNode) {
          notif.remove();
        }
      }, 5000);
    }

    // Make removeChild available globally
    window.removeChild = removeChild;
  </script>
</body>
</html>
