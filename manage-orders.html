<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Orders - Artios Academies Cafe</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2em;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .header .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      padding: 30px;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #1976d2;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Authentication Info */
    .auth-info {
      background: #e8f5e8;
      border: 2px solid #4caf50;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .auth-info a, .auth-info button {
      transition: all 0.3s ease;
      text-decoration: none;
      font-weight: 600;
    }

    .auth-info a {
      background: #4caf50;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 10px;
    }

    .auth-info a:hover {
      background: #43a047;
      color: white;
    }

    .auth-info button {
      background: #666;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .auth-info button:hover {
      background: #555;
    }

    /* Order Lookup Form */
    .lookup-section {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }

    .lookup-section h3 {
      color: #1976d2;
      margin-bottom: 20px;
      font-size: 1.3em;
    }

    .lookup-form {
      display: flex;
      gap: 15px;
      max-width: 600px;
      margin: 0 auto;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 250px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      text-align: left;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .form-group input[readonly] {
      background: #f0f9ff;
      cursor: not-allowed;
    }

    .lookup-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      align-self: end;
    }

    .lookup-btn:hover {
      background: #1976d2;
      transform: translateY(-1px);
    }

    .lookup-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Order Display */
    .order-section {
      display: none;
    }

    .order-header {
      background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
      border: 2px solid #4caf50;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      text-align: center;
    }

    .order-id {
      font-size: 1.5em;
      font-weight: 700;
      color: #2e7d32;
      margin-bottom: 10px;
    }

    .order-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      color: #333;
    }

    /* Day Sections */
    .day-section {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .day-header {
      background: #2196f3;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .day-title {
      font-size: 1.2em;
      font-weight: 600;
    }

    .day-status {
      font-size: 0.9em;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 15px;
    }

    .day-status.can-cancel {
      background: #4caf50;
    }

    .day-status.locked {
      background: #ff5722;
    }

    .children-container {
      padding: 20px;
    }

    .child-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .child-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .child-name {
      font-size: 1.1em;
      font-weight: 600;
      color: #1976d2;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .child-icon {
      background: #1976d2;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      font-weight: bold;
    }

    .item-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 12px 15px;
      border-radius: 8px;
      border-left: 4px solid #4caf50;
      transition: all 0.3s ease;
    }

    .order-item.cancelled {
      background: #ffebee;
      border-left-color: #f44336;
      opacity: 0.7;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-weight: 600;
      color: #333;
    }

    .item-price {
      color: #4caf50;
      font-weight: 600;
      font-size: 0.9em;
    }

    .cancel-btn {
      background: #ff5722;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .cancel-btn:hover {
      background: #d32f2f;
      transform: scale(1.05);
    }

    .cancel-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .cancelled-status {
      color: #f44336;
      font-weight: 600;
      font-size: 0.9em;
    }

    /* Refund Summary */
    .refund-summary {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }

    .refund-amount {
      font-size: 1.5em;
      font-weight: 700;
      color: #f57c00;
      margin-bottom: 10px;
    }

    /* Status Messages */
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e0e0e0;
      border-top: 3px solid #2196f3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .lookup-form {
        flex-direction: column;
      }

      .form-group {
        min-width: auto;
      }

      .order-details {
        grid-template-columns: 1fr;
      }

      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .main-content {
        padding: 20px;
      }

      .auth-info {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìã Manage Your Orders</h1>
      <div class="subtitle">Cancel items, request refunds, or view order history</div>
    </div>

    <div class="main-content">
      <a href="dashboard.html" class="back-link">‚Üê Back to Dashboard</a>

      <!-- Order Lookup Section -->
      <div class="lookup-section" id="lookup-section">
        <h3>üîç Your Family Orders</h3>
        <p style="color: #666; margin-bottom: 20px;">View and manage your family's lunch orders</p>
        <form class="lookup-form" id="lookup-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" placeholder="parent@example.com" required readonly>
            <small style="color: #666; font-style: italic; margin-top: 5px; display: block;">Email is locked to your authenticated account for security</small>
          </div>
          <div class="form-group">
            <label for="order-id">Order ID (Optional)</label>
            <input type="text" id="order-id" placeholder="SMITH-0815-0730">
          </div>
          <button type="submit" class="lookup-btn" id="lookup-btn">Find Orders</button>
        </form>
      </div>

      <!-- Order Display Section -->
      <div class="order-section" id="order-section">
        <div id="orders-container">
          <!-- Orders will be populated by JavaScript -->
        </div>

        <!-- Refund Summary -->
        <div class="refund-summary" id="refund-summary" style="display: none;">
          <div class="refund-amount">Total Pending Refunds: $<span id="total-refunds">0.00</span></div>
          <p>Refunds will be processed via Venmo within 24 hours</p>
        </div>
      </div>

      <div class="status-message" id="status-message" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Configuration
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec'
    };

    let currentOrders = [];

    // Add authentication check at the VERY TOP
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication FIRST before anything else
      if (!checkAuthentication()) {
        return; // Will redirect to login, so stop execution
      }
      
      // Continue with initialization for authenticated users
      const urlParams = new URLSearchParams(window.location.search);
      const emailParam = urlParams.get('email');
      
      if (emailParam) {
        document.getElementById('email').value = decodeURIComponent(emailParam);
      }

      // Auto-submit if email provided
      if (emailParam) {
        setTimeout(() => {
          findOrders();
        }, 500);
      }

      // Setup form submission
      document.getElementById('lookup-form').addEventListener('submit', function(e) {
        e.preventDefault();
        findOrders();
      });
    });

    /**
     * Check if user is authenticated to view orders
     */
    function checkAuthentication() {
      const authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
      const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
      const urlParams = new URLSearchParams(window.location.search);
      const requestedEmail = urlParams.get('email');
      
      console.log('Checking authentication...');
      console.log('Authenticated email:', authenticatedEmail);
      console.log('Requested email:', requestedEmail);
      
      // Check if authentication exists and is not expired
      if (!authenticatedEmail || !authExpiry || Date.now() >= authExpiry) {
        console.log('‚ùå No valid authentication found');
        redirectToLogin(requestedEmail);
        return false;
      }
      
      // Check if user is trying to access their own orders
      if (requestedEmail && authenticatedEmail.toLowerCase() !== requestedEmail.toLowerCase()) {
        console.log('‚ùå User trying to access different email orders');
        showSecurityAlert();
        redirectToLogin();
        return false;
      }
      
      console.log('‚úÖ Authentication check passed');
      
      // Show authenticated user info and pre-fill email
      showAuthenticatedUserInfo(authenticatedEmail);
      document.getElementById('email').value = authenticatedEmail;
      
      return true;
    }

    /**
     * Redirect to login page
     */
    function redirectToLogin(email = null) {
      let loginUrl = 'login.html';
      if (email) {
        loginUrl += `?email=${encodeURIComponent(email)}`;
      }
      
      // Clear any existing auth
      sessionStorage.removeItem('authenticatedEmail');
      sessionStorage.removeItem('authExpiry');
      
      // Show brief message before redirect
      document.body.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f8f9fa; font-family: Arial, sans-serif;">
          <div style="text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <div style="font-size: 3em; margin-bottom: 20px;">üîí</div>
            <h2 style="color: #1976d2; margin-bottom: 15px;">Login Required</h2>
            <p style="color: #666; margin-bottom: 20px;">Please login to access your family orders</p>
            <div style="font-size: 14px; color: #999;">Redirecting to login...</div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        window.location.href = loginUrl;
      }, 2000);
    }

    /**
     * Show security alert for unauthorized access attempt
     */
    function showSecurityAlert() {
      alert('üîí Security Alert\n\nYou can only access orders for your own family email address.\n\nPlease login with the correct family account.');
    }

    /**
     * Show authenticated user info at top of page
     */
    function showAuthenticatedUserInfo(email) {
      const mainContent = document.querySelector('.main-content');
      if (mainContent) {
        const authInfoDiv = document.createElement('div');
        authInfoDiv.className = 'auth-info';
        authInfoDiv.innerHTML = `
          <div>
            <span style="color: #2e7d32; font-weight: 600;">üîì Logged in as: </span>
            <span style="color: #333; font-weight: 500;">${email}</span>
          </div>
          <div>
            <a href="dashboard.html">Dashboard</a>
            <button onclick="logout()">Logout</button>
          </div>
        `;
        
        mainContent.insertBefore(authInfoDiv, mainContent.firstChild);
      }
    }

    /**
     * Logout function
     */
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('authenticatedEmail');
        sessionStorage.removeItem('authExpiry');
        window.location.href = 'login.html';
      }
    }

    /**
     * Find orders with authentication check
     */
    function findOrders() {
      const email = document.getElementById('email').value.trim();
      const orderId = document.getElementById('order-id').value.trim();
      const authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
      const lookupBtn = document.getElementById('lookup-btn');
      
      // Security check - ensure user can only look up their own orders
      if (email.toLowerCase() !== authenticatedEmail.toLowerCase()) {
        showMessage('üîí You can only view orders for your authenticated email address', 'error');
        document.getElementById('email').value = authenticatedEmail; // Reset to correct email
        return;
      }
      
      if (!email) {
        showMessage('Please enter your email address', 'error');
        return;
      }

      lookupBtn.disabled = true;
      lookupBtn.textContent = 'üîç Searching...';
      showMessage('üîç Searching for your orders...', 'info');
      
      // Build API URL
      let apiUrl = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=lookup_orders&email=${encodeURIComponent(email)}`;
      if (orderId) {
        apiUrl += `&order_id=${encodeURIComponent(orderId)}`;
      }

      console.log('Calling API:', apiUrl);

      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          console.log('API Response:', data);
          
          if (data.success && data.orders && data.orders.length > 0) {
            currentOrders = data.orders;
            displayOrders(data.orders);
            hideMessage();
          } else if (data.success && data.orders && data.orders.length === 0) {
            showMessage('No orders found for your account.', 'error');
          } else {
            showMessage(`Error: ${data.error || 'Failed to find orders'}`, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showMessage('Network error. Please check your connection and try again.', 'error');
        })
        .finally(() => {
          lookupBtn.disabled = false;
          lookupBtn.textContent = 'Find Orders';
        });
    }

    function displayOrders(orders) {
      // Hide lookup section and show order section
      document.getElementById('lookup-section').style.display = 'none';
      document.getElementById('order-section').style.display = 'block';

      const ordersContainer = document.getElementById('orders-container');
      ordersContainer.innerHTML = '';

      orders.forEach(order => {
        const orderDiv = createOrderDisplay(order);
        ordersContainer.appendChild(orderDiv);
      });

      calculateRefundSummary();
    }

    function createOrderDisplay(order) {
      const orderDiv = document.createElement('div');
      orderDiv.className = 'order-wrapper';
      orderDiv.style.marginBottom = '40px';

      // Group items by day
      const itemsByDay = {};
      order.items.forEach(item => {
        if (!itemsByDay[item.day]) {
          itemsByDay[item.day] = [];
        }
        itemsByDay[item.day].push(item);
      });

      // Sort days
      const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
      const sortedDays = Object.keys(itemsByDay).sort((a, b) => {
        return dayOrder.indexOf(a) - dayOrder.indexOf(b);
      });

      // Create order header
      const orderHeader = document.createElement('div');
      orderHeader.className = 'order-header';
      
      const orderDate = new Date(order.timestamp).toLocaleDateString();
      const activeItems = order.items.filter(item => item.status === 'active').length;
      const cancelledItems = order.items.filter(item => item.status === 'cancelled').length;

      orderHeader.innerHTML = `
        <div class="order-id">Order #${order.orderId}</div>
        <div class="order-details">
          <div><strong>üìÖ Order Date:</strong> ${orderDate}</div>
          <div><strong>üë• Children:</strong> ${order.children.length}</div>
          <div><strong>üí∞ Original Total:</strong> $${order.total.toFixed(2)}</div>
          <div><strong>üìã Status:</strong> ${activeItems} active, ${cancelledItems} cancelled</div>
        </div>
      `;

      orderDiv.appendChild(orderHeader);

      // Create day sections
      sortedDays.forEach(dayName => {
        const dayDiv = createDaySection(dayName, itemsByDay[dayName]);
        orderDiv.appendChild(dayDiv);
      });

      return orderDiv;
    }

    function createDaySection(dayName, items) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day-section';

      // Check if day can be cancelled (8:15 AM rule)
      const itemDate = new Date(items[0].date + 'T08:15:00');
      const now = new Date();
      const canCancel = now <= itemDate;

      const statusClass = canCancel ? 'can-cancel' : 'locked';
      const statusText = canCancel ? `Can Cancel Until ${itemDate.toLocaleDateString()} 8:15 AM` : 'Cancellation Deadline Passed';

      dayDiv.innerHTML = `
        <div class="day-header">
          <div class="day-title">${dayName}, ${new Date(items[0].date).toLocaleDateString()}</div>
          <div class="day-status ${statusClass}">${statusText}</div>
        </div>
        <div class="children-container">
          ${createChildrenSections(items, canCancel)}
        </div>
      `;

      return dayDiv;
    }

    function createChildrenSections(items, canCancel) {
      // Group items by child
      const itemsByChild = {};
      items.forEach(item => {
        if (!itemsByChild[item.childName]) {
          itemsByChild[item.childName] = [];
        }
        itemsByChild[item.childName].push(item);
      });

      let html = '';
      let childIndex = 1;

      Object.keys(itemsByChild).forEach(childName => {
        html += `
          <div class="child-section">
            <div class="child-name">
              <div class="child-icon">${childIndex}</div>
              ${childName}
            </div>
            <div class="item-list">
              ${itemsByChild[childName].map(item => `
                <div class="order-item ${item.status === 'cancelled' ? 'cancelled' : ''}">
                  <div class="item-details">
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                  </div>
                  ${item.status === 'cancelled' ? 
                    '<div class="cancelled-status">CANCELLED</div>' : 
                    (canCancel ? 
                      `<button class="cancel-btn" onclick="cancelItem('${item.id}', '${item.name}', ${item.price}, '${childName}')">Cancel Item</button>` :
                      '<button class="cancel-btn" disabled>Too Late</button>')
                  }
                </div>
              `).join('')}
            </div>
          </div>
        `;
        childIndex++;
      });

      return html;
    }

    function cancelItem(itemId, itemName, itemPrice, childName) {
      const reason = prompt(`Why are you cancelling ${itemName} for ${childName}?\n\nCommon reasons:\n‚Ä¢ Child is sick\n‚Ä¢ Child will be absent\n‚Ä¢ Changed mind\n‚Ä¢ Other`);
      
      if (reason === null) {
        return; // User cancelled the prompt
      }

      const finalReason = reason.trim() || 'Parent requested';
      
      if (confirm(`Cancel ${itemName} for ${childName}?\n\nRefund: $${itemPrice.toFixed(2)}\nReason: ${finalReason}\n\nThis action cannot be undone.`)) {
        showMessage(`‚è≥ Cancelling ${itemName}...`, 'info');
        
        const apiUrl = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=cancel_item&item_id=${encodeURIComponent(itemId)}&reason=${encodeURIComponent(finalReason)}`;
        
        console.log('Calling cancellation API:', apiUrl);
        
        fetch(apiUrl)
          .then(response => response.json())
          .then(data => {
            console.log('Cancellation response:', data);
            
            if (data.success) {
              showMessage(`‚úÖ ${itemName} cancelled successfully! Refund of $${itemPrice.toFixed(2)} will be processed within 24 hours.`, 'success');
              
              // Update the UI
              const itemElement = document.querySelector(`button[onclick*="${itemId}"]`).closest('.order-item');
              itemElement.classList.add('cancelled');
              itemElement.querySelector('.cancel-btn').outerHTML = '<div class="cancelled-status">CANCELLED</div>';
              
              // Update the item in our data
              currentOrders.forEach(order => {
                order.items.forEach(item => {
                  if (item.id === itemId) {
                    item.status = 'cancelled';
                  }
                });
              });
              
              calculateRefundSummary();
            } else {
              showMessage(`‚ùå ${data.message || 'Failed to cancel item'}`, 'error');
            }
          })
          .catch(error => {
            console.error('Cancellation error:', error);
            showMessage('Network error. Please try again.', 'error');
          });
      }
    }

    function calculateRefundSummary() {
      let totalRefunds = 0;
      let refundCount = 0;

      currentOrders.forEach(order => {
        order.items.forEach(item => {
          if (item.status === 'cancelled') {
            totalRefunds += item.price;
            refundCount++;
          }
        });
      });

      const refundSummary = document.getElementById('refund-summary');
      if (totalRefunds > 0) {
        document.getElementById('total-refunds').textContent = totalRefunds.toFixed(2);
        refundSummary.style.display = 'block';
      } else {
        refundSummary.style.display = 'none';
      }
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('status-message');
      messageDiv.textContent = message;
      messageDiv.className = `status-message ${type}`;
      messageDiv.style.display = 'block';
      
      // Auto-hide success and info messages
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          hideMessage();
        }, 5000);
      }
    }

    function hideMessage() {
      document.getElementById('status-message').style.display = 'none';
    }

    // Make functions available globally
    window.cancelItem = cancelItem;
    window.logout = logout;
  </script>
</body>
</html>
