<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artios Academies Admin - Report Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      padding: 20px;
    }

    .admin-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 800px;
      width: 100%;
      text-align: center;
    }

    .admin-header {
      margin-bottom: 30px;
    }

    .admin-title {
      font-size: 2.2em;
      font-weight: 700;
      color: #4285f4;
      margin-bottom: 10px;
    }

    .admin-subtitle {
      color: #666;
      font-size: 1.1em;
    }

    .tab-container {
      margin-bottom: 30px;
    }

    .tab-buttons {
      display: flex;
      background: #f5f5f5;
      border-radius: 10px;
      padding: 5px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #666;
    }

    .tab-btn.active {
      background: #4285f4;
      color: white;
      box-shadow: 0 2px 10px rgba(66, 133, 244, 0.3);
    }

    .tab-btn:hover:not(.active) {
      background: rgba(66, 133, 244, 0.1);
      color: #4285f4;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Report Generation Styles */
    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .date-input, .file-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .date-input:focus, .file-input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    /* Email Recipients Section */
    .email-recipients {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
      text-align: left;
    }

    .email-recipients h4 {
      color: #4285f4;
      margin-bottom: 15px;
      font-size: 1.1em;
      text-align: center;
    }

    .email-checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .email-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .email-checkbox:hover {
      border-color: #4285f4;
      background: rgba(66, 133, 244, 0.05);
    }

    .email-checkbox.checked {
      border-color: #34a853;
      background: rgba(52, 168, 83, 0.1);
    }

    .email-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .email-checkbox label {
      cursor: pointer;
      margin: 0;
      font-weight: 500;
      flex: 1;
    }

    .email-address {
      font-family: monospace;
      color: #666;
      font-size: 0.9em;
    }

    /* Custom Email Input Styles */
    .custom-email {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .custom-email label {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .custom-email-input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: monospace;
      transition: all 0.3s ease;
      min-width: 200px;
    }

    .custom-email-input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }

    .custom-email-input:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .email-error {
      color: #d32f2f;
      font-size: 0.85em;
      margin-top: 8px;
      display: none;
    }

    /* Button Styles */
    .generate-btn, .upload-btn, .reconcile-btn {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
      border: none;
      padding: 18px 35px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 20px;
    }

    .reconcile-btn {
      background: linear-gradient(135deg, #3d95ce 0%, #2980b9 100%);
    }

    .generate-btn:hover:not(:disabled),
    .upload-btn:hover:not(:disabled),
    .reconcile-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(66, 133, 244, 0.4);
    }

    .generate-btn:disabled,
    .upload-btn:disabled,
    .reconcile-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .test-connection-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      width: 100%;
    }

    .test-connection-btn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }

    /* Status Messages */
    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .status-message.show {
      opacity: 1;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    /* Quick Dates */
    .quick-dates {
      margin-top: 20px;
    }

    .quick-dates h4 {
      margin-bottom: 10px;
      color: #666;
      font-size: 0.9em;
    }

    .quick-date-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .quick-date-btn {
      background: #f5f5f5;
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .quick-date-btn:hover {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .admin-container {
        padding: 20px;
        margin: 10px;
      }

      .tab-buttons {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1 class="admin-title">📊 Artios Academies Admin Portal</h1>
      <p class="admin-subtitle">Report Generation System</p>
    </div>

    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="reports">📋 Generate Reports</button>
      </div>

      <!-- Reports Tab -->
      <div class="tab-content active" id="reports-tab">
        <form id="report-form">
          <div class="form-group">
            <label for="report-date">Select Report Date:</label>
            <input type="date" id="report-date" class="date-input" required>
          </div>

          <!-- Email Recipients Section -->
          <div class="email-recipients">
            <h4>📧 Email Report To:</h4>
            <div class="email-checkbox-group">
              <div class="email-checkbox" id="admin-checkbox">
                <input type="checkbox" id="email-admin" checked>
                <label for="email-admin">
                  <strong>Jeremiah Daws</strong>
                  <div class="email-address">jedaws@gmail.com</div>
                </label>
              </div>
              <div class="email-checkbox" id="crivers-checkbox">
                <input type="checkbox" id="email-crivers" checked>
                <label for="email-crivers">
                  <strong>Chan Ta Rivers</strong>
                  <div class="email-address">CRivers@artiosacademies.com</div>
                </label>
              </div>
              <div class="email-checkbox custom-email" id="custom-checkbox">
                <input type="checkbox" id="email-custom">
                <label for="email-custom">
                  <strong>Cafe Worker (Simple List):</strong>
                  <input type="email" 
                         id="custom-email-input" 
                         class="custom-email-input" 
                         placeholder="worker@example.com">
                </label>
              </div>
            </div>
            <div class="email-error" id="email-error">
              Please select at least one email recipient or enter a cafe worker email
            </div>
          </div>

          <button type="submit" class="generate-btn" id="generate-btn">
            📋 Generate Report
          </button>

          <button type="button" class="test-connection-btn" id="test-btn">
            🔧 Test Google Sheets Connection
          </button>

          <div class="quick-dates">
            <h4>Quick Select:</h4>
            <div class="quick-date-buttons">
              <button type="button" class="quick-date-btn" data-offset="0">Today</button>
              <button type="button" class="quick-date-btn" data-offset="1">Tomorrow</button>
              <button type="button" class="quick-date-btn" data-offset="-1">Yesterday</button>
            </div>
          </div>

          <div class="status-message" id="status-message"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Configuration - UPDATE THIS SECTION TO MATCH YOUR MAIN FORM
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec',
      useGoogleSheets: true
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Set default date to today
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      document.getElementById('report-date').value = todayStr;

      // Setup event listeners
      setupEventListeners();
      updateEmailCheckboxStyles();
    });

    function setupEventListeners() {
      // Report form submission
      document.getElementById('report-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generateReport();
      });

      // Test connection
      document.getElementById('test-btn').addEventListener('click', testConnection);

      // Quick date buttons
      document.querySelectorAll('.quick-date-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const offset = parseInt(this.dataset.offset);
          const date = new Date();
          date.setDate(date.getDate() + offset);
          const dateStr = date.toISOString().split('T')[0];
          document.getElementById('report-date').value = dateStr;
        });
      });

      // Email checkbox events
      document.querySelectorAll('.email-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateEmailCheckboxStyles);
      });

      // Custom email input events
      const customEmailInput = document.getElementById('custom-email-input');
      const customEmailCheckbox = document.getElementById('email-custom');
      
      // Enable/disable custom email input based on checkbox
      customEmailCheckbox.addEventListener('change', function() {
        customEmailInput.disabled = !this.checked;
        if (!this.checked) {
          customEmailInput.value = '';
        }
        updateEmailCheckboxStyles();
      });

      // Auto-check the custom checkbox when typing in the input
      customEmailInput.addEventListener('input', function() {
        if (this.value.trim() && !customEmailCheckbox.checked) {
          customEmailCheckbox.checked = true;
        }
        updateEmailCheckboxStyles();
      });

      // Initialize custom email input as disabled
      customEmailInput.disabled = true;
    }

    // Report Generation Functions
    function updateEmailCheckboxStyles() {
      // Update checkbox styling
      document.querySelectorAll('.email-checkbox').forEach(checkboxDiv => {
        const checkbox = checkboxDiv.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
          checkboxDiv.classList.add('checked');
        } else {
          checkboxDiv.classList.remove('checked');
        }
      });

      // Validate at least one is selected or custom email is entered
      const adminChecked = document.getElementById('email-admin').checked;
      const criversChecked = document.getElementById('email-crivers').checked;
      const customChecked = document.getElementById('email-custom').checked;
      const customEmail = document.getElementById('custom-email-input').value.trim();
      const errorDiv = document.getElementById('email-error');

      const hasValidSelection = adminChecked || criversChecked || (customChecked && customEmail && customEmail.includes('@'));

      if (!hasValidSelection) {
        errorDiv.style.display = 'block';
        if (customChecked && !customEmail) {
          errorDiv.textContent = 'Please enter a valid cafe worker email address';
        } else {
          errorDiv.textContent = 'Please select at least one email recipient or enter a cafe worker email';
        }
      } else {
        errorDiv.style.display = 'none';
      }
    }

    function generateReport() {
      const dateInput = document.getElementById('report-date').value;
      const generateBtn = document.getElementById('generate-btn');
      
      // Get email recipients
      const emailAdmin = document.getElementById('email-admin').checked;
      const emailCrivers = document.getElementById('email-crivers').checked;
      const emailCustom = document.getElementById('email-custom').checked;
      const customEmail = document.getElementById('custom-email-input').value.trim();
      
      // Validate recipients
      if (!emailAdmin && !emailCrivers && !emailCustom) {
        showStatus('Please select at least one email recipient', 'error');
        return;
      }

      if (emailCustom && (!customEmail || !customEmail.includes('@'))) {
        showStatus('Please enter a valid cafe worker email address', 'error');
        return;
      }

      if (!dateInput) {
        showStatus('Please select a date', 'error');
        return;
      }

      if (!GOOGLE_SHEETS_CONFIG.webAppUrl) {
        showStatus('Google Sheets URL not configured', 'error');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.textContent = '⏳ Generating Report...';
      
      // Build recipients list - separate admin emails from worker email
      const adminRecipients = [];
      const workerRecipients = [];
      
      if (emailAdmin) adminRecipients.push('jedaws@gmail.com');
      if (emailCrivers) adminRecipients.push('CRivers@artiosacademies.com');
      if (emailCustom && customEmail) workerRecipients.push(customEmail);
      
      const totalRecipients = adminRecipients.length + workerRecipients.length;
      showStatus(`Generating report for ${dateInput} (sending to ${totalRecipients} recipient${totalRecipients > 1 ? 's' : ''})...`, 'info');

      const reportUrl = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=generate_report&secret=cafe2025&date=${dateInput}&admin_recipients=${encodeURIComponent(adminRecipients.join(','))}&worker_recipients=${encodeURIComponent(workerRecipients.join(','))}`;

      fetch(reportUrl)
        .then(response => response.json())
        .then(data => {
          console.log('Report response:', data);
          
          if (data.success) {
            let message = `✅ Report Generated Successfully!\n\n`;
            message += `📅 Date: ${dateInput}\n`;
            message += `🍽️ Orders Found: ${data.ordersProcessed}\n`;
            
            if (adminRecipients.length > 0) {
              message += `📧 Detailed admin report sent to:\n`;
              adminRecipients.forEach(email => {
                if (email === 'jedaws@gmail.com') message += `  • Jeremiah Daws (${email})\n`;
                else if (email === 'CRivers@artiosacademies.com') message += `  • Chan Ta Rivers (${email})\n`;
                else message += `  • ${email}\n`;
              });
            }
            
            if (workerRecipients.length > 0) {
              message += `👷 Simple cafe worker list sent to:\n`;
              workerRecipients.forEach(email => {
                message += `  • ${email}\n`;
              });
            }
            
            if (data.ordersProcessed > 0) {
              message += `\nThe report includes customer order details and restaurant preparation summary.`;
              showStatus(`Report sent: ${data.ordersProcessed} orders for ${dateInput}`, 'success');
            } else {
              message += `\nNo orders found for this date. ✅ No Chick-fil-A order needed!`;
              showStatus(`No orders found for ${dateInput}`, 'info');
            }

            // Show simple success message on page instead of popup
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = message.replace(/\n/g, '<br>');
            statusDiv.className = 'status-message success show';

          } else {
            showStatus(`Report failed: ${data.error}`, 'error');
          }
        })
        .catch(error => {
          console.error('Report error:', error);
          showStatus('Network error generating report', 'error');
        })
        .finally(() => {
          generateBtn.disabled = false;
          generateBtn.textContent = '📋 Generate Report';
        });
    }

    function testConnection() {
      const testBtn = document.getElementById('test-btn');
      
      if (!GOOGLE_SHEETS_CONFIG.webAppUrl) {
        showStatus('Google Sheets URL not configured', 'error');
        return;
      }

      testBtn.disabled = true;
      testBtn.textContent = '🔧 Testing...';
      showStatus('Testing Google Sheets connection...', 'info');

      const testUrl = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=test&test=true`;

      fetch(testUrl)
        .then(response => response.json())
        .then(result => {
          showStatus('✅ Google Sheets connection successful!', 'success');
        })
        .catch(error => {
          console.error('Connection test failed:', error);
          showStatus('❌ Google Sheets connection failed', 'error');
        })
        .finally(() => {
          testBtn.disabled = false;
          testBtn.textContent = '🔧 Test Google Sheets Connection';
        });
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.textContent = message;
      statusDiv.className = `status-message ${type} show`;

      setTimeout(() => {
        statusDiv.classList.remove('show');
      }, 8000);
    }
  </script>
</body>
</html>
