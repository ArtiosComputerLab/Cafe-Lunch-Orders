<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cafe Admin - Report Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
    }

    .admin-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    .admin-header {
      margin-bottom: 30px;
    }

    .admin-title {
      font-size: 2.2em;
      font-weight: 700;
      color: #4285f4;
      margin-bottom: 10px;
    }

    .admin-subtitle {
      color: #666;
      font-size: 1.1em;
    }

    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .date-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .date-input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    /* Email Recipients Section */
    .email-recipients {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
      text-align: left;
    }

    .email-recipients h4 {
      color: #4285f4;
      margin-bottom: 15px;
      font-size: 1.1em;
      text-align: center;
    }

    .email-checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .email-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .email-checkbox:hover {
      border-color: #4285f4;
      background: rgba(66, 133, 244, 0.05);
    }

    .email-checkbox.checked {
      border-color: #34a853;
      background: rgba(52, 168, 83, 0.1);
    }

    .email-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .email-checkbox label {
      cursor: pointer;
      margin: 0;
      font-weight: 500;
      flex: 1;
    }

    .email-address {
      font-family: monospace;
      color: #666;
      font-size: 0.9em;
    }

    /* Custom Email Input Styles */
    .custom-email {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .custom-email label {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .custom-email-input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: monospace;
      transition: all 0.3s ease;
      min-width: 200px;
    }

    .custom-email-input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }

    .custom-email-input:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .email-error {
      color: #d32f2f;
      font-size: 0.85em;
      margin-top: 8px;
      display: none;
    }

    .generate-btn {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
      border: none;
      padding: 18px 35px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 20px;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(66, 133, 244, 0.4);
    }

    .generate-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .test-connection-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      width: 100%;
    }

    .test-connection-btn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }

    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .status-message.show {
      opacity: 1;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .quick-dates {
      margin-top: 20px;
    }

    .quick-dates h4 {
      margin-bottom: 10px;
      color: #666;
      font-size: 0.9em;
    }

    .quick-date-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .quick-date-btn {
      background: #f5f5f5;
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .quick-date-btn:hover {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }

    .config-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-top: 25px;
      text-align: left;
      font-size: 0.85em;
    }

    .config-info h4 {
      margin-bottom: 8px;
      color: #495057;
    }

    .config-url {
      font-family: monospace;
      background: #e9ecef;
      padding: 4px 6px;
      border-radius: 4px;
      word-break: break-all;
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1 class="admin-title">ðŸ“Š Cafe Admin</h1>
      <p class="admin-subtitle">Generate Daily Reports</p>
    </div>

    <form id="report-form">
      <div class="form-group">
        <label for="report-date">Select Report Date:</label>
        <input type="date" id="report-date" class="date-input" required>
      </div>

      <!-- Email Recipients Section -->
      <div class="email-recipients">
        <h4>ðŸ“§ Email Report To:</h4>
        <div class="email-checkbox-group">
          <div class="email-checkbox" id="admin-checkbox">
            <input type="checkbox" id="email-admin" checked>
            <label for="email-admin">
              <strong>Jeremiah Daws</strong>
              <div class="email-address">jedaws@gmail.com</div>
            </label>
          </div>
          <div class="email-checkbox" id="crivers-checkbox">
            <input type="checkbox" id="email-crivers" checked>
            <label for="email-crivers">
              <strong>Chan Ta Rivers</strong>
              <div class="email-address">CRivers@artiosacademies.com</div>
            </label>
          </div>
          <div class="email-checkbox custom-email" id="custom-checkbox">
            <input type="checkbox" id="email-custom">
            <label for="email-custom">
              <strong>Other:</strong>
              <input type="email" 
                     id="custom-email-input" 
                     class="custom-email-input" 
                     placeholder="Enter email address">
            </label>
          </div>
        </div>
        <div class="email-error" id="email-error">
          Please select at least one email recipient or enter a custom email
        </div>
      </div>

      <button type="submit" class="generate-btn" id="generate-btn">
        ðŸ“‹ Generate Report
      </button>

      <button type="button" class="test-connection-btn" id="test-btn">
        ðŸ”§ Test Google Sheets Connection
      </button>

      <div class="quick-dates">
        <h4>Quick Select:</h4>
        <div class="quick-date-buttons">
          <button type="button" class="quick-date-btn" data-offset="0">Today</button>
          <button type="button" class="quick-date-btn" data-offset="1">Tomorrow</button>
          <button type="button" class="quick-date-btn" data-offset="2">Day After</button>
          <button type="button" class="quick-date-btn" data-offset="-1">Yesterday</button>
        </div>
      </div>

      <div class="status-message" id="status-message"></div>

      <div class="config-info">
        <h4>Configuration Status:</h4>
        <p><strong>Google Sheets URL:</strong></p>
        <div class="config-url" id="config-url">Loading...</div>
      </div>
    </form>
  </div>

  <script>
    // Configuration - UPDATE THIS SECTION TO MATCH YOUR MAIN FORM
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec',
      useGoogleSheets: true
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Set default date to today
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      document.getElementById('report-date').value = todayStr;

      // Show configuration
      document.getElementById('config-url').textContent = GOOGLE_SHEETS_CONFIG.webAppUrl || 'Not configured';

      // Setup event listeners
      setupEventListeners();
      updateEmailCheckboxStyles();
    });

    function setupEventListeners() {
      // Form submission
      document.getElementById('report-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generateReport();
      });

      // Test connection
      document.getElementById('test-btn').addEventListener('click', testConnection);

      // Quick date buttons
      document.querySelectorAll('.quick-date-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const offset = parseInt(this.dataset.offset);
          const date = new Date();
          date.setDate(date.getDate() + offset);
          const dateStr = date.toISOString().split('T')[0];
          document.getElementById('report-date').value = dateStr;
        });
      });

      // Email checkbox events
      document.querySelectorAll('.email-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateEmailCheckboxStyles);
      });

      // Custom email input events
      const customEmailInput = document.getElementById('custom-email-input');
      const customEmailCheckbox = document.getElementById('email-custom');
      
      // Enable/disable custom email input based on checkbox
      customEmailCheckbox.addEventListener('change', function() {
        customEmailInput.disabled = !this.checked;
        if (!this.checked) {
          customEmailInput.value = '';
        }
        updateEmailCheckboxStyles();
      });

      // Auto-check the custom checkbox when typing in the input
      customEmailInput.addEventListener('input', function() {
        if (this.value.trim() && !customEmailCheckbox.checked) {
          customEmailCheckbox.checked = true;
        }
        updateEmailCheckboxStyles();
      });

      // Initialize custom email input as disabled
      customEmailInput.disabled = true;
    }

    function updateEmailCheckboxStyles() {
      // Update checkbox styling
      document.querySelectorAll('.email-checkbox').forEach(checkboxDiv => {
        const checkbox = checkboxDiv.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
          checkboxDiv.classList.add('checked');
        } else {
          checkboxDiv.classList.remove('checked');
        }
      });

      // Validate at least one is selected or custom email is entered
      const adminChecked = document.getElementById('email-admin').checked;
      const criversChecked = document.getElementById('email-crivers').checked;
      const customChecked = document.getElementById('email-custom').checked;
      const customEmail = document.getElementById('custom-email-input').value.trim();
      const errorDiv = document.getElementById('email-error');

      const hasValidSelection = adminChecked || criversChecked || (customChecked && customEmail && customEmail.includes('@'));

      if (!hasValidSelection) {
        errorDiv.style.display = 'block';
        if (customChecked && !customEmail) {
          errorDiv.textContent = 'Please enter a valid email address';
        } else {
          errorDiv.textContent = 'Please select at least one email recipient or enter a custom email';
        }
      } else {
        errorDiv.style.display = 'none';
      }
    }

    function generateReport() {
      const dateInput = document.getElementById('report-date').value;
      const generateBtn = document.getElementById('generate-btn');
      
      // Get email recipients
      const emailAdmin = document.getElementById('email-admin').checked;
      const emailCrivers = document.getElementById('email-crivers').checked;
      const emailCustom = document.getElementById('email-custom').checked;
      const customEmail = document.getElementById('custom-email-input').value.trim();
      
      // Validate recipients
      if (!emailAdmin && !emailCrivers && !emailCustom) {
        showStatus('Please select at least one email recipient', 'error');
        return;
      }

      if (emailCustom && (!customEmail || !customEmail.includes('@'))) {
        showStatus('Please enter a valid custom email address', 'error');
        return;
      }

      if (!dateInput) {
        showStatus('Please select a date', 'error');
        return;
      }

      if (!GOOGLE_SHEETS_CONFIG.webAppUrl) {
        showStatus('Google Sheets URL not configured', 'error');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.textContent = 'â³ Generating Report...';
      
      // Build recipients list
      const recipients = [];
      if (emailAdmin) recipients.push('jedaws@gmail.com');
      if (emailCrivers) recipients.push('CRivers@artiosacademies.com');
      if (emailCustom && customEmail) recipients.push(customEmail);
      
      showStatus(`Generating report for ${dateInput} (sending to ${recipients.length} recipient${recipients.length > 1 ? 's' : ''})...`, 'info');

      const reportUrl = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=generate_report&secret=cafe2025&date=${dateInput}&recipients=${encodeURIComponent(recipients.join(','))}`;

      fetch(reportUrl)
        .then(response => response.json())
        .then(data => {
          console.log('Report response:', data);
          
          if (data.success) {
            let message = `âœ… Report Generated Successfully!\n\n`;
            message += `ðŸ“… Date: ${dateInput}\n`;
            message += `ðŸ“Š Sheet: ${data.sheetName}\n`;
            message += `ðŸ½ï¸ Orders Found: ${data.ordersProcessed}\n`;
            message += `ðŸ“§ Email sent to:\n`;
            recipients.forEach(email => {
              if (email === 'jedaws@gmail.com') message += `  â€¢ Jeremiah Daws (${email})\n`;
              else if (email === 'CRivers@artiosacademies.com') message += `  â€¢ Chan Ta Rivers (${email})\n`;
              else message += `  â€¢ ${email}\n`;
            });
            message += `\n`;
            
            if (data.ordersProcessed > 0) {
              message += `The report includes:\n`;
              message += `â€¢ Customer order details\n`;
              message += `â€¢ Restaurant preparation summary\n`;
              message += `â€¢ Item counts and totals\n`;
              message += `â€¢ Copy-friendly ordering format\n\n`;
              showStatus(`Report created: ${data.ordersProcessed} orders for ${dateInput}`, 'success');
            } else {
              message += `No orders found for this date.\n`;
              message += `âœ… No Chick-fil-A order needed!\n\n`;
              showStatus(`No orders found for ${dateInput}`, 'info');
            }

            message += `Check your Google Sheet and email for details.`;
            alert(message);

            if (data.sheetUrl) {
              setTimeout(() => {
                if (confirm('Open the Google Sheet to view the report?')) {
                  window.open(data.sheetUrl, '_blank');
                }
              }, 1000);
            }
          } else {
            showStatus(`Report failed: ${data.error}`, 'error');
            alert(`âŒ Report Generation Failed!\n\nError: ${data.error}\n\nPlease check your Google Apps Script configuration.`);
          }
        })
        .catch(error => {
          console.error('Report error:', error);
          showStatus('Network error generating report', 'error');
          alert(`âŒ Network Error!\n\nFailed to generate report: ${error.message}\n\nPlease check your internet connection and Google Apps Script URL.`);
        })
        .finally(() => {
          generateBtn.disabled = false;
          generateBtn.textContent = 'ðŸ“‹ Generate Report';
        });
    }

    function testConnection() {
      const testBtn = document.getElementById('test-btn');
      
      if (!GOOGLE_SHEETS_CONFIG.webAppUrl) {
        showStatus('Google Sheets URL not configured', 'error');
        return;
      }

      testBtn.disabled = true;
      testBtn.textContent = 'ðŸ”§ Testing...';
      showStatus('Testing Google Sheets connection...', 'info');

      const testUrl = `${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=test&test=true`;

      fetch(testUrl)
        .then(response => {
          console.log('Test response status:', response.status, response.statusText);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.text();
        })
        .then(result => {
          console.log('Raw test response:', result);
          
          try {
            const jsonResult = JSON.parse(result);
            console.log('Parsed test response:', jsonResult);
            showStatus('âœ… Google Sheets connection successful!', 'success');
            
            let message = `âœ… Connection Test PASSED!\n\n`;
            message += `Google Apps Script is working correctly.\n`;
            message += `Response: ${JSON.stringify(jsonResult, null, 2)}`;
            alert(message);
          } catch (parseError) {
            console.log('Response is not JSON:', result);
            showStatus('âš ï¸ Connection works but unexpected response', 'info');
            
            let message = `âš ï¸ Connection Test Results:\n\n`;
            message += `Google Sheets responded, but not with expected JSON.\n\n`;
            message += `Raw response: ${result.substring(0, 500)}...\n\n`;
            message += `This might indicate a Google Apps Script configuration issue.`;
            alert(message);
          }
        })
        .catch(error => {
          console.error('Connection test failed:', error);
          showStatus('âŒ Google Sheets connection failed', 'error');
          
          let message = `âŒ Connection Test FAILED!\n\n`;
          message += `Error: ${error.message}\n\n`;
          message += `Possible issues:\n`;
          message += `â€¢ Google Apps Script not deployed properly\n`;
          message += `â€¢ Wrong URL in configuration\n`;
          message += `â€¢ Script permissions not granted\n`;
          message += `â€¢ CORS/network issues\n\n`;
          message += `URL: ${GOOGLE_SHEETS_CONFIG.webAppUrl}`;
          alert(message);
        })
        .finally(() => {
          testBtn.disabled = false;
          testBtn.textContent = 'ðŸ”§ Test Google Sheets Connection';
        });
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.textContent = message;
      statusDiv.className = `status-message ${type} show`;

      setTimeout(() => {
        statusDiv.classList.remove('show');
      }, 5000);
    }
  </script>
</body>
</html>
